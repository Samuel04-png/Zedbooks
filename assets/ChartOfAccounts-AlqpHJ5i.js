import{a0 as ge,u as je,r as N,b as fe,d as L,G as Z,H as P,J as U,K as M,a1 as I,j as a,L as be,B as h,F as ee,aa as ae,ae as _e,a3 as Ne,ab as ne,ac as ce,ad as te,k as p,I as v,V as F,W as E,X as k,Y as D,Z as g,af as se,ag as oe,f as $,i as re,U as ve,a6 as Ce,g as Ae,h as we,$ as H,q as Se,s as Te,t as ie,v as j,w as Ie,x as f,ah as Fe,ai as Ee,a4 as i,a2 as ke,O as R,P as K,aj as De,ak as Q,al as Oe,am as Be,y as V}from"./index-CQ7zAlQo.js";const C=[{value:"asset",label:"Asset",normalBalance:"Debit"},{value:"liability",label:"Liability",normalBalance:"Credit"},{value:"equity",label:"Equity",normalBalance:"Credit"},{value:"income",label:"Income",normalBalance:"Credit"},{value:"expense",label:"Expense",normalBalance:"Debit"}],qe={asset:[1e3,1999],liability:[2e3,2999],equity:[3e3,3999],income:[4e3,4999],expense:[5e3,5999]},le=(r,n)=>{const l=Number(n);if(!Number.isFinite(l))return"Code must be a number";const m=qe[r.toLowerCase()];return m&&(l<m[0]||l>m[1])?`Code must be between ${m[0]} and ${m[1]} for ${r}`:null},A=r=>{const n=r.toLowerCase();return n==="revenue"?"income":n},b=r=>{const n=A(r),l=C.find(m=>m.value===n);return(l==null?void 0:l.label)||"Expense"},ze=r=>A(r);function Pe(){const r=ge(),{user:n}=je(),[l,m]=N.useState(""),[O,de]=N.useState("all"),[ue,B]=N.useState(!1),[w,_]=N.useState(null),[c,d]=N.useState({account_code:"",account_name:"",account_type:"",description:"",parent_account_id:""}),{data:o,isLoading:me}=fe({queryKey:["chart-of-accounts",n==null?void 0:n.id],queryFn:async()=>{if(!n)return[];const e=await L.getPrimaryMembershipByUser(n.id);if(!(e!=null&&e.companyId))return[];const t=Z(K,R.CHART_OF_ACCOUNTS),[u,x,T]=await Promise.all([P(U(t,M("companyId","==",e.companyId))),P(U(t,M("organizationId","==",e.companyId))),P(U(t,M("organization_id","==",e.companyId)))]),X=new Map;return[u,x,T].forEach(y=>{y.docs.forEach(s=>{X.set(s.id,s)})}),[...X.values()].map(y=>{const s=y.data();return{id:y.id,companyId:String(s.companyId??s.organizationId??s.organization_id??""),accountCode:Number(s.accountCode??s.account_code??0),accountName:String(s.accountName??s.account_name??""),accountType:ze(String(s.accountType??s.account_type??"expense")),description:s.description??null,parentAccountId:s.parentAccountId??s.parent_account_id??null,status:String(s.status??(s.isActive===!1?"inactive":"active")),isSystemAccount:!!(s.isSystemAccount??s.is_system_account??s.isSystem??!1)}}).sort((y,s)=>y.accountCode-s.accountCode)},enabled:!!n}),Y=I({mutationFn:async e=>{if(!n)throw new Error("Not authenticated");const t=await L.getPrimaryMembershipByUser(n.id);if(!(t!=null&&t.companyId))throw new Error("Company context not found");const u=Number(e.account_code);if(!Number.isFinite(u))throw new Error("Account number must be numeric");const x=b(e.account_type),T=le(x,e.account_code);if(T)throw new Error(T);await De(Z(K,R.CHART_OF_ACCOUNTS),{companyId:t.companyId,organizationId:t.companyId,accountCode:u,account_code:u,accountName:e.account_name,account_name:e.account_name,accountType:b(e.account_type),account_type:b(e.account_type),description:e.description||null,parentAccountId:e.parent_account_id||null,parent_account_id:e.parent_account_id||null,status:"active",isSystem:!1,isSystemAccount:!1,isActive:!0,is_active:!0,createdAt:Q(),updatedAt:Q()})},onSuccess:()=>{r.invalidateQueries({queryKey:["chart-of-accounts",n==null?void 0:n.id]}),i.success("Account created successfully"),z(),B(!1)},onError:e=>{i.error(`Failed to create account: ${e instanceof Error?e.message:"Unknown error"}`)}}),G=I({mutationFn:async e=>{const t=Number(e.account_code);if(!Number.isFinite(t))throw new Error("Account number must be numeric");const u=b(e.account_type),x=le(u,e.account_code);if(x)throw new Error(x);await Oe(Be(K,R.CHART_OF_ACCOUNTS,e.id),{companyId:e.companyId,organizationId:e.companyId,accountCode:t,account_code:t,accountName:e.account_name,account_name:e.account_name,accountType:b(e.account_type),account_type:b(e.account_type),description:e.description||null,parentAccountId:e.parent_account_id||null,parent_account_id:e.parent_account_id||null,updatedAt:Q()},{merge:!0})},onSuccess:()=>{r.invalidateQueries({queryKey:["chart-of-accounts",n==null?void 0:n.id]}),i.success("Account updated successfully"),z(),_(null)},onError:e=>{i.error(`Failed to update account: ${e instanceof Error?e.message:"Unknown error"}`)}}),he=I({mutationFn:async({id:e,companyId:t})=>{await V.deleteChartOfAccount({companyId:t,accountId:e})},onSuccess:()=>{r.invalidateQueries({queryKey:["chart-of-accounts",n==null?void 0:n.id]}),i.success("Account deleted successfully")},onError:e=>{i.error(`Failed to delete account: ${e instanceof Error?e.message:"Unknown error"}`)}}),q=I({mutationFn:async()=>{if(!n)throw new Error("Not authenticated");const e=await L.getPrimaryMembershipByUser(n.id);if(!(e!=null&&e.companyId))throw new Error("Company context not found");await V.seedDefaultChartOfAccounts({companyId:e.companyId}),await V.seedDefaultExpenseCategories({companyId:e.companyId})},onSuccess:()=>{r.invalidateQueries({queryKey:["chart-of-accounts",n==null?void 0:n.id]}),i.success("Default chart of accounts and expense categories seeded successfully")},onError:e=>{i.error(`Failed to setup accounts: ${e instanceof Error?e.message:"Unknown error"}`)}}),z=()=>{d({account_code:"",account_name:"",account_type:"",description:"",parent_account_id:""})},pe=e=>{if(e.isSystemAccount){i.error("System accounts cannot be renamed or edited.");return}_(e),d({account_code:String(e.accountCode),account_name:e.accountName,account_type:e.accountType,description:e.description||"",parent_account_id:e.parentAccountId||""})},xe=e=>{switch(A(e)){case"asset":return{min:1e3,max:1999,label:"1000-1999"};case"liability":return{min:2e3,max:2999,label:"2000-2999"};case"equity":return{min:3e3,max:3999,label:"3000-3999"};case"income":return{min:4e3,max:4999,label:"4000-4999"};case"expense":return{min:5e3,max:5999,label:"5000-5999"};default:return null}},J=()=>{if(!c.account_code||!c.account_name||!c.account_type){i.error("Please fill in all required fields");return}const e=Number(c.account_code);if(!Number.isFinite(e)){i.error("Account number must be numeric");return}const t=xe(c.account_type);if(t&&(e<t.min||e>t.max)){i.error(`Invalid account code for ${c.account_type}. Must be between ${t.label}`);return}w?G.mutate({...c,id:w.id,companyId:w.companyId}):Y.mutate(c)},W=e=>{const t=C.find(u=>u.value===A(e));return(t==null?void 0:t.normalBalance)||"-"},ye=e=>{switch(A(e)){case"asset":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";case"liability":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";case"equity":return"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200";case"income":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";case"expense":return"bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200";default:return"bg-muted text-muted-foreground"}},S=o==null?void 0:o.filter(e=>{const t=e.accountName.toLowerCase().includes(l.toLowerCase())||String(e.accountCode).includes(l),u=O==="all"||e.accountType===O;return t&&u});return me?a.jsx(be,{message:"Loading chart of accounts..."}):a.jsxs("div",{className:"space-y-6",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Chart of Accounts"}),a.jsx("p",{className:"text-muted-foreground",children:"Manage your organization's account structure"})]}),a.jsxs("div",{className:"flex gap-2",children:[(!o||o.length===0)&&a.jsxs(h,{variant:"outline",onClick:()=>q.mutate(),disabled:q.isPending,children:[a.jsx(ee,{className:"h-4 w-4 mr-2"}),"Setup Default Accounts"]}),a.jsxs(ae,{open:ue,onOpenChange:B,children:[a.jsx(_e,{asChild:!0,children:a.jsxs(h,{onClick:()=>{z(),_(null)},children:[a.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Add Account"]})}),a.jsxs(ne,{className:"max-w-md",children:[a.jsx(ce,{children:a.jsx(te,{children:"Add New Account"})}),a.jsxs("div",{className:"space-y-4 py-4",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"account_code",children:"Account Number *"}),a.jsx(v,{id:"account_code",placeholder:"e.g., 1000",value:c.account_code,onChange:e=>d({...c,account_code:e.target.value})})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"account_type",children:"Account Type *"}),a.jsxs(F,{value:c.account_type,onValueChange:e=>d({...c,account_type:e}),children:[a.jsx(E,{children:a.jsx(k,{placeholder:"Select type"})}),a.jsx(D,{children:C.map(e=>a.jsx(g,{value:e.value,children:e.label},e.value))})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"account_name",children:"Account Name *"}),a.jsx(v,{id:"account_name",placeholder:"e.g., Cash on Hand",value:c.account_name,onChange:e=>d({...c,account_name:e.target.value})})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"parent_account",children:"Parent Account (Optional)"}),a.jsxs(F,{value:c.parent_account_id||"none",onValueChange:e=>d({...c,parent_account_id:e==="none"?"":e}),children:[a.jsx(E,{children:a.jsx(k,{placeholder:"Select parent account"})}),a.jsxs(D,{children:[a.jsx(g,{value:"none",children:"None"}),o==null?void 0:o.filter(e=>e.accountType===c.account_type).map(e=>a.jsxs(g,{value:e.id,children:[e.accountCode," - ",e.accountName]},e.id))]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"description",children:"Description"}),a.jsx(se,{id:"description",placeholder:"Brief description of this account",value:c.description,onChange:e=>d({...c,description:e.target.value}),rows:3})]}),c.account_type&&a.jsx("div",{className:"p-3 bg-muted rounded-lg",children:a.jsxs("p",{className:"text-sm text-muted-foreground",children:["Normal Balance:"," ",a.jsx("span",{className:"font-medium text-foreground",children:W(c.account_type)})]})})]}),a.jsxs(oe,{children:[a.jsx(h,{variant:"outline",onClick:()=>B(!1),children:"Cancel"}),a.jsx(h,{onClick:J,disabled:Y.isPending,children:"Create Account"})]})]})]})]})]}),a.jsx($,{children:a.jsx(re,{className:"pt-6",children:a.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[a.jsxs("div",{className:"relative flex-1",children:[a.jsx(ve,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),a.jsx(v,{placeholder:"Search accounts...",className:"pl-10",value:l,onChange:e=>m(e.target.value)})]}),a.jsxs(F,{value:O,onValueChange:de,children:[a.jsxs(E,{className:"w-full sm:w-[200px]",children:[a.jsx(Ce,{className:"h-4 w-4 mr-2"}),a.jsx(k,{placeholder:"Filter by type"})]}),a.jsxs(D,{children:[a.jsx(g,{value:"all",children:"All Types"}),C.map(e=>a.jsx(g,{value:e.value,children:e.label},e.value))]})]})]})})}),!S||S.length===0?a.jsx($,{className:"p-12",children:a.jsxs("div",{className:"text-center",children:[a.jsx(ee,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),a.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No accounts found"}),a.jsx("p",{className:"text-muted-foreground mb-4",children:(o==null?void 0:o.length)===0?"Set up your chart of accounts to start tracking your finances":"No accounts match your search criteria"}),(o==null?void 0:o.length)===0&&a.jsx(h,{onClick:()=>q.mutate(),children:"Setup Default Accounts"})]})}):a.jsxs($,{children:[a.jsx(Ae,{children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx(we,{children:"Account List"}),a.jsxs(H,{variant:"secondary",children:[S.length," accounts"]})]})}),a.jsx(re,{children:a.jsx("div",{className:"rounded-md border",children:a.jsxs(Se,{children:[a.jsx(Te,{children:a.jsxs(ie,{className:"bg-amber-50 dark:bg-amber-950/20",children:[a.jsx(j,{className:"font-bold",children:"Account Number"}),a.jsx(j,{className:"font-bold",children:"Account Name"}),a.jsx(j,{className:"font-bold",children:"Account Type"}),a.jsx(j,{className:"font-bold",children:"Normal Balance"}),a.jsx(j,{className:"font-bold",children:"Description"}),a.jsx(j,{className:"text-right font-bold",children:"Actions"})]})}),a.jsx(Ie,{children:S.map(e=>a.jsxs(ie,{className:"hover:bg-muted/50",children:[a.jsx(f,{className:"font-mono font-medium",children:e.accountCode}),a.jsx(f,{className:"font-medium",children:a.jsxs("div",{className:"flex items-center gap-2",children:[e.parentAccountId&&a.jsx(Fe,{className:"h-4 w-4 text-muted-foreground"}),e.accountName]})}),a.jsx(f,{children:a.jsx(H,{className:ye(e.accountType),variant:"secondary",children:e.accountType})}),a.jsx(f,{children:a.jsx(H,{variant:"outline",children:W(e.accountType)})}),a.jsx(f,{className:"text-muted-foreground max-w-xs truncate",children:e.description||"-"}),a.jsx(f,{className:"text-right",children:a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsx(h,{variant:"ghost",size:"icon",disabled:e.isSystemAccount,title:e.isSystemAccount?"System accounts cannot be edited":"Edit account",onClick:()=>pe(e),children:a.jsx(Ee,{className:"h-4 w-4"})}),a.jsx(h,{variant:"ghost",size:"icon",disabled:e.isSystemAccount,title:e.isSystemAccount?"System accounts cannot be deleted":"Delete account",onClick:()=>{if(e.isSystemAccount){i.error("System accounts cannot be deleted.");return}confirm("Delete this account? This is blocked if it has journal history or child accounts.")&&he.mutate({id:e.id,companyId:e.companyId})},children:a.jsx(ke,{className:"h-4 w-4 text-destructive"})})]})})]},e.id))})]})})})]}),a.jsx(ae,{open:!!w,onOpenChange:e=>!e&&_(null),children:a.jsxs(ne,{className:"max-w-md",children:[a.jsx(ce,{children:a.jsx(te,{children:"Edit Account"})}),a.jsxs("div",{className:"space-y-4 py-4",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"edit_account_code",children:"Account Number *"}),a.jsx(v,{id:"edit_account_code",value:c.account_code,onChange:e=>d({...c,account_code:e.target.value})})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"edit_account_type",children:"Account Type *"}),a.jsxs(F,{value:c.account_type,onValueChange:e=>d({...c,account_type:e}),children:[a.jsx(E,{children:a.jsx(k,{placeholder:"Select type"})}),a.jsx(D,{children:C.map(e=>a.jsx(g,{value:e.value,children:e.label},e.value))})]})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"edit_account_name",children:"Account Name *"}),a.jsx(v,{id:"edit_account_name",value:c.account_name,onChange:e=>d({...c,account_name:e.target.value})})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(p,{htmlFor:"edit_description",children:"Description"}),a.jsx(se,{id:"edit_description",value:c.description,onChange:e=>d({...c,description:e.target.value}),rows:3})]})]}),a.jsxs(oe,{children:[a.jsx(h,{variant:"outline",onClick:()=>_(null),children:"Cancel"}),a.jsx(h,{onClick:J,disabled:G.isPending,children:"Save Changes"})]})]})})]})}export{Pe as default};
