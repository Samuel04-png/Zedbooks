import{u as F,r as h,b as G,d as J,G as K,H as P,J as Q,Q as W,K as X,j as e,S as Y,B as Z,D as z,f as b,g as v,h as D,U as ee,i as I,k as x,I as y,V as A,W as T,X as C,Y as L,Z as j,_ as se,$ as O,q as te,s as ae,t as N,v as m,w as re,x as u,A as V,O as ne,P as ce}from"./index-V3-pWDnM.js";const le=a=>{if(!a)return new Date(0).toISOString();if(typeof a=="string"){const n=new Date(a);return Number.isNaN(n.getTime())?new Date(0).toISOString():n.toISOString()}if(a instanceof Date)return a.toISOString();if(typeof a=="object"&&a!==null&&"toDate"in a){const n=a;if(typeof n.toDate=="function")return n.toDate().toISOString()}return new Date(0).toISOString()};function de(){const{user:a}=F(),[n,U]=h.useState(""),[p,R]=h.useState("all"),[f,_]=h.useState("all"),[w,k]=h.useState(()=>{const s=new Date;return s.setMonth(s.getMonth()-1),s.toISOString().split("T")[0]}),[g,B]=h.useState(new Date().toISOString().split("T")[0]),{data:S=[],isLoading:H}=G({queryKey:["audit-logs",a==null?void 0:a.id],queryFn:async()=>{if(!a)return[];const s=await J.getPrimaryMembershipByUser(a.id);if(!(s!=null&&s.companyId))return[];const d=K(ce,ne.AUDIT_LOGS);return(await P(Q(d,X("companyId","==",s.companyId),W(1e3)))).docs.map(c=>{const t=c.data(),r=t.details||null;return{id:c.id,userId:t.actorUid??t.userId??t.user_id??null,action:String(t.action??"unknown"),tableName:String(t.tableName??t.table_name??(r==null?void 0:r.sourceCollection)??(r==null?void 0:r.sourceType)??"-"),recordId:t.recordId??t.record_id??(r==null?void 0:r.sourceId)??null,oldValues:t.oldValues??t.old_values??null,newValues:t.newValues??t.new_values??r??null,ipAddress:t.ipAddress??t.ip_address??null,createdAt:le(t.createdAt??t.created_at)}}).sort((c,t)=>t.createdAt.localeCompare(c.createdAt))},enabled:!!a}),i=S.filter(s=>{var c;const d=s.createdAt.slice(0,10);if(d<w||d>g||p!=="all"&&s.tableName!==p||f!=="all"&&s.action!==f)return!1;if(!n)return!0;const o=n.toLowerCase();return s.action.toLowerCase().includes(o)||s.tableName.toLowerCase().includes(o)||((c=s.recordId)==null?void 0:c.toLowerCase().includes(o))}),E=Array.from(new Set(S.map(s=>s.tableName))).sort(),M=Array.from(new Set(S.map(s=>s.action))).sort(),q=s=>{switch(s.toLowerCase()){case"create":case"insert":return"default";case"update":return"secondary";case"delete":return"destructive";default:return"outline"}},$=()=>{if(i.length===0)return;const s=["Timestamp","Action","Table","Record ID","User ID"],d=i.map(l=>[V(new Date(l.createdAt),"yyyy-MM-dd HH:mm:ss"),l.action,l.tableName,l.recordId||"",l.userId||""]),o=[s,...d].map(l=>l.join(",")).join(`
`),c=new Blob([o],{type:"text/csv"}),t=window.URL.createObjectURL(c),r=document.createElement("a");r.href=t,r.download=`audit-logs-${w}-to-${g}.csv`,r.click(),window.URL.revokeObjectURL(t)};return H?e.jsx("div",{className:"flex items-center justify-center h-64",children:"Loading..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold tracking-tight flex items-center gap-2",children:[e.jsx(Y,{className:"h-8 w-8"}),"Audit Logs"]}),e.jsx("p",{className:"text-muted-foreground",children:"Track all system activities and changes"})]}),e.jsxs(Z,{variant:"outline",onClick:$,disabled:i.length===0,children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5"}),"Filters"]})}),e.jsx(I,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-5",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Search"}),e.jsx(y,{placeholder:"Search logs...",value:n,onChange:s=>U(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Table"}),e.jsxs(A,{value:p,onValueChange:R,children:[e.jsx(T,{children:e.jsx(C,{})}),e.jsxs(L,{children:[e.jsx(j,{value:"all",children:"All Tables"}),E.map(s=>e.jsx(j,{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Action"}),e.jsxs(A,{value:f,onValueChange:_,children:[e.jsx(T,{children:e.jsx(C,{})}),e.jsxs(L,{children:[e.jsx(j,{value:"all",children:"All Actions"}),M.map(s=>e.jsx(j,{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Start Date"}),e.jsx(y,{type:"date",value:w,onChange:s=>k(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"End Date"}),e.jsx(y,{type:"date",value:g,onChange:s=>B(s.target.value)})]})]})})]}),e.jsxs(b,{children:[e.jsx(v,{children:e.jsxs(D,{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5"}),"Activity Log"]}),e.jsxs(O,{variant:"outline",children:[i.length," records"]})]})}),e.jsx(I,{children:e.jsxs(te,{children:[e.jsx(ae,{children:e.jsxs(N,{children:[e.jsx(m,{children:"Timestamp"}),e.jsx(m,{children:"Action"}),e.jsx(m,{children:"Table"}),e.jsx(m,{children:"Record ID"}),e.jsx(m,{children:"Details"})]})}),e.jsxs(re,{children:[i.map(s=>e.jsxs(N,{children:[e.jsx(u,{className:"whitespace-nowrap",children:V(new Date(s.createdAt),"yyyy-MM-dd HH:mm:ss")}),e.jsx(u,{children:e.jsx(O,{variant:q(s.action),children:s.action.toUpperCase()})}),e.jsx(u,{className:"font-mono text-sm",children:s.tableName}),e.jsx(u,{className:"font-mono text-xs text-muted-foreground",children:s.recordId?`${s.recordId.slice(0,8)}...`:"-"}),e.jsx(u,{className:"max-w-xs",children:s.newValues&&e.jsxs("details",{className:"cursor-pointer",children:[e.jsx("summary",{className:"text-sm text-muted-foreground",children:"View changes"}),e.jsx("pre",{className:"text-xs mt-2 p-2 bg-muted rounded overflow-auto max-h-32",children:JSON.stringify(s.newValues,null,2)})]})})]},s.id)),i.length===0&&e.jsx(N,{children:e.jsx(u,{colSpan:5,className:"text-center text-muted-foreground py-8",children:"No audit logs found for the selected criteria."})})]})]})})]})]})}export{de as default};
