import{a0 as ue,u as me,r as b,b as he,d as q,G as V,H as xe,J as pe,K as ye,a1 as w,j as e,L as je,B as x,F as Y,aa as G,ae as ge,a3 as fe,ab as J,ac as W,ad as X,k as p,I as N,V as S,W as T,X as F,Y as I,Z as y,af as Z,ag as ee,f as U,i as ae,U as be,a6 as Ne,g as ve,h as _e,$ as L,q as Ce,s as Ae,t as ne,v as j,w as we,x as g,ah as Se,ai as Te,a4 as i,a2 as Fe,O as P,P as $,aj as Ie,ak as H,al as Ee,am as ke,y as M}from"./index-DCVq7BzL.js";const v=[{value:"asset",label:"Asset",normalBalance:"Debit"},{value:"liability",label:"Liability",normalBalance:"Credit"},{value:"equity",label:"Equity",normalBalance:"Credit"},{value:"income",label:"Income",normalBalance:"Credit"},{value:"expense",label:"Expense",normalBalance:"Debit"}],De={asset:[1e3,19999],liability:[2e3,29999],equity:[3e3,39999],income:[4e3,49999],expense:[5e3,99999]},ce=(o,n)=>{const l=Number(n);if(!Number.isFinite(l))return"Code must be a number";const u=De[o.toLowerCase()];return u&&(l<u[0]||l>u[1])?`Code must be between ${u[0]} and ${u[1]} for ${o}`:null},_=o=>{const n=o.toLowerCase();return n==="revenue"?"income":n},E=o=>{const n=_(o),l=v.find(u=>u.value===n);return(l==null?void 0:l.label)||"Expense"},Be=o=>_(o);function qe(){const o=ue(),{user:n}=me(),[l,u]=b.useState(""),[k,te]=b.useState("all"),[se,D]=b.useState(!1),[C,f]=b.useState(null),[c,d]=b.useState({account_code:"",account_name:"",account_type:"",description:"",parent_account_id:""}),{data:r,isLoading:re}=he({queryKey:["chart-of-accounts",n==null?void 0:n.id],queryFn:async()=>{if(!n)return[];const a=await q.getPrimaryMembershipByUser(n.id);if(!(a!=null&&a.companyId))return[];const t=V($,P.CHART_OF_ACCOUNTS);return(await xe(pe(t,ye("companyId","==",a.companyId)))).docs.map(h=>{const s=h.data();return{id:h.id,companyId:String(s.companyId??""),accountCode:Number(s.accountCode??s.account_code??0),accountName:String(s.accountName??s.account_name??""),accountType:Be(String(s.accountType??s.account_type??"expense")),description:s.description??null,parentAccountId:s.parentAccountId??s.parent_account_id??null,status:String(s.status??(s.isActive===!1?"inactive":"active")),isSystemAccount:!!(s.isSystemAccount??s.is_system_account??s.isSystem??!1)}}).sort((h,s)=>h.accountCode-s.accountCode)},enabled:!!n}),R=w({mutationFn:async a=>{if(!n)throw new Error("Not authenticated");const t=await q.getPrimaryMembershipByUser(n.id);if(!(t!=null&&t.companyId))throw new Error("Company context not found");const m=Number(a.account_code);if(!Number.isFinite(m))throw new Error("Account number must be numeric");const h=E(a.account_type),s=ce(h,a.account_code);if(s)throw new Error(s);await Ie(V($,P.CHART_OF_ACCOUNTS),{companyId:t.companyId,accountCode:m,accountName:a.account_name,accountType:E(a.account_type),description:a.description||null,parentAccountId:a.parent_account_id||null,status:"active",isSystem:!1,isSystemAccount:!1,createdAt:H(),updatedAt:H()})},onSuccess:()=>{o.invalidateQueries({queryKey:["chart-of-accounts",n==null?void 0:n.id]}),i.success("Account created successfully"),O(),D(!1)},onError:a=>{i.error(`Failed to create account: ${a instanceof Error?a.message:"Unknown error"}`)}}),z=w({mutationFn:async a=>{const t=Number(a.account_code);if(!Number.isFinite(t))throw new Error("Account number must be numeric");const m=E(a.account_type),h=ce(m,a.account_code);if(h)throw new Error(h);await Ee(ke($,P.CHART_OF_ACCOUNTS,a.id),{companyId:a.companyId,accountCode:t,accountName:a.account_name,accountType:E(a.account_type),description:a.description||null,parentAccountId:a.parent_account_id||null,updatedAt:H()},{merge:!0})},onSuccess:()=>{o.invalidateQueries({queryKey:["chart-of-accounts",n==null?void 0:n.id]}),i.success("Account updated successfully"),O(),f(null)},onError:a=>{i.error(`Failed to update account: ${a instanceof Error?a.message:"Unknown error"}`)}}),oe=w({mutationFn:async({id:a,companyId:t})=>{await M.deleteChartOfAccount({companyId:t,accountId:a})},onSuccess:()=>{o.invalidateQueries({queryKey:["chart-of-accounts",n==null?void 0:n.id]}),i.success("Account deleted successfully")},onError:a=>{i.error(`Failed to delete account: ${a instanceof Error?a.message:"Unknown error"}`)}}),B=w({mutationFn:async()=>{if(!n)throw new Error("Not authenticated");const a=await q.getPrimaryMembershipByUser(n.id);if(!(a!=null&&a.companyId))throw new Error("Company context not found");await M.seedDefaultChartOfAccounts({companyId:a.companyId}),await M.seedDefaultExpenseCategories({companyId:a.companyId})},onSuccess:()=>{o.invalidateQueries({queryKey:["chart-of-accounts",n==null?void 0:n.id]}),i.success("Default chart of accounts and expense categories seeded successfully")},onError:a=>{i.error(`Failed to setup accounts: ${a instanceof Error?a.message:"Unknown error"}`)}}),O=()=>{d({account_code:"",account_name:"",account_type:"",description:"",parent_account_id:""})},ie=a=>{if(a.isSystemAccount){i.error("System accounts cannot be renamed or edited.");return}f(a),d({account_code:String(a.accountCode),account_name:a.accountName,account_type:a.accountType,description:a.description||"",parent_account_id:a.parentAccountId||""})},le=a=>{switch(_(a)){case"asset":return{min:1e3,max:19999,label:"1000-19999"};case"liability":return{min:2e3,max:29999,label:"2000-29999"};case"equity":return{min:3e3,max:39999,label:"3000-39999"};case"income":return{min:4e3,max:49999,label:"4000-49999"};case"expense":return{min:5e3,max:99999,label:"5000-99999"};default:return null}},K=()=>{if(!c.account_code||!c.account_name||!c.account_type){i.error("Please fill in all required fields");return}const a=Number(c.account_code);if(!Number.isFinite(a)){i.error("Account number must be numeric");return}const t=le(c.account_type);if(t&&(a<t.min||a>t.max)){i.error(`Invalid account code for ${c.account_type}. Must be between ${t.label}`);return}C?z.mutate({...c,id:C.id,companyId:C.companyId}):R.mutate(c)},Q=a=>{const t=v.find(m=>m.value===_(a));return(t==null?void 0:t.normalBalance)||"-"},de=a=>{switch(_(a)){case"asset":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";case"liability":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";case"equity":return"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200";case"income":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";case"expense":return"bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200";default:return"bg-muted text-muted-foreground"}},A=r==null?void 0:r.filter(a=>{const t=a.accountName.toLowerCase().includes(l.toLowerCase())||String(a.accountCode).includes(l),m=k==="all"||a.accountType===k;return t&&m});return re?e.jsx(je,{message:"Loading chart of accounts..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Chart of Accounts"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage your organization's account structure"})]}),e.jsxs("div",{className:"flex gap-2",children:[(!r||r.length===0)&&e.jsxs(x,{variant:"outline",onClick:()=>B.mutate(),disabled:B.isPending,children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"Setup Default Accounts"]}),e.jsxs(G,{open:se,onOpenChange:D,children:[e.jsx(ge,{asChild:!0,children:e.jsxs(x,{onClick:()=>{O(),f(null)},children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Add Account"]})}),e.jsxs(J,{className:"max-w-md",children:[e.jsx(W,{children:e.jsx(X,{children:"Add New Account"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"account_code",children:"Account Number *"}),e.jsx(N,{id:"account_code",placeholder:"e.g., 1000",value:c.account_code,onChange:a=>d({...c,account_code:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"account_type",children:"Account Type *"}),e.jsxs(S,{value:c.account_type,onValueChange:a=>d({...c,account_type:a}),children:[e.jsx(T,{children:e.jsx(F,{placeholder:"Select type"})}),e.jsx(I,{children:v.map(a=>e.jsx(y,{value:a.value,children:a.label},a.value))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"account_name",children:"Account Name *"}),e.jsx(N,{id:"account_name",placeholder:"e.g., Cash on Hand",value:c.account_name,onChange:a=>d({...c,account_name:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"parent_account",children:"Parent Account (Optional)"}),e.jsxs(S,{value:c.parent_account_id||"none",onValueChange:a=>d({...c,parent_account_id:a==="none"?"":a}),children:[e.jsx(T,{children:e.jsx(F,{placeholder:"Select parent account"})}),e.jsxs(I,{children:[e.jsx(y,{value:"none",children:"None"}),r==null?void 0:r.filter(a=>a.accountType===c.account_type).map(a=>e.jsxs(y,{value:a.id,children:[a.accountCode," - ",a.accountName]},a.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"description",children:"Description"}),e.jsx(Z,{id:"description",placeholder:"Brief description of this account",value:c.description,onChange:a=>d({...c,description:a.target.value}),rows:3})]}),c.account_type&&e.jsx("div",{className:"p-3 bg-muted rounded-lg",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Normal Balance:"," ",e.jsx("span",{className:"font-medium text-foreground",children:Q(c.account_type)})]})})]}),e.jsxs(ee,{children:[e.jsx(x,{variant:"outline",onClick:()=>D(!1),children:"Cancel"}),e.jsx(x,{onClick:K,disabled:R.isPending,children:"Create Account"})]})]})]})]})]}),e.jsx(U,{children:e.jsx(ae,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(N,{placeholder:"Search accounts...",className:"pl-10",value:l,onChange:a=>u(a.target.value)})]}),e.jsxs(S,{value:k,onValueChange:te,children:[e.jsxs(T,{className:"w-full sm:w-[200px]",children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),e.jsx(F,{placeholder:"Filter by type"})]}),e.jsxs(I,{children:[e.jsx(y,{value:"all",children:"All Types"}),v.map(a=>e.jsx(y,{value:a.value,children:a.label},a.value))]})]})]})})}),!A||A.length===0?e.jsx(U,{className:"p-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Y,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No accounts found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:(r==null?void 0:r.length)===0?"Set up your chart of accounts to start tracking your finances":"No accounts match your search criteria"}),(r==null?void 0:r.length)===0&&e.jsx(x,{onClick:()=>B.mutate(),children:"Setup Default Accounts"})]})}):e.jsxs(U,{children:[e.jsx(ve,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(_e,{children:"Account List"}),e.jsxs(L,{variant:"secondary",children:[A.length," accounts"]})]})}),e.jsx(ae,{children:e.jsx("div",{className:"rounded-md border",children:e.jsxs(Ce,{children:[e.jsx(Ae,{children:e.jsxs(ne,{className:"bg-amber-50 dark:bg-amber-950/20",children:[e.jsx(j,{className:"font-bold",children:"Account Number"}),e.jsx(j,{className:"font-bold",children:"Account Name"}),e.jsx(j,{className:"font-bold",children:"Account Type"}),e.jsx(j,{className:"font-bold",children:"Normal Balance"}),e.jsx(j,{className:"font-bold",children:"Description"}),e.jsx(j,{className:"text-right font-bold",children:"Actions"})]})}),e.jsx(we,{children:A.map(a=>e.jsxs(ne,{className:"hover:bg-muted/50",children:[e.jsx(g,{className:"font-mono font-medium",children:a.accountCode}),e.jsx(g,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[a.parentAccountId&&e.jsx(Se,{className:"h-4 w-4 text-muted-foreground"}),a.accountName]})}),e.jsx(g,{children:e.jsx(L,{className:de(a.accountType),variant:"secondary",children:a.accountType})}),e.jsx(g,{children:e.jsx(L,{variant:"outline",children:Q(a.accountType)})}),e.jsx(g,{className:"text-muted-foreground max-w-xs truncate",children:a.description||"-"}),e.jsx(g,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(x,{variant:"ghost",size:"icon",disabled:a.isSystemAccount,title:a.isSystemAccount?"System accounts cannot be edited":"Edit account",onClick:()=>ie(a),children:e.jsx(Te,{className:"h-4 w-4"})}),e.jsx(x,{variant:"ghost",size:"icon",disabled:a.isSystemAccount,title:a.isSystemAccount?"System accounts cannot be deleted":"Delete account",onClick:()=>{if(a.isSystemAccount){i.error("System accounts cannot be deleted.");return}confirm("Delete this account? This is blocked if it has journal history or child accounts.")&&oe.mutate({id:a.id,companyId:a.companyId})},children:e.jsx(Fe,{className:"h-4 w-4 text-destructive"})})]})})]},a.id))})]})})})]}),e.jsx(G,{open:!!C,onOpenChange:a=>!a&&f(null),children:e.jsxs(J,{className:"max-w-md",children:[e.jsx(W,{children:e.jsx(X,{children:"Edit Account"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"edit_account_code",children:"Account Number *"}),e.jsx(N,{id:"edit_account_code",value:c.account_code,onChange:a=>d({...c,account_code:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"edit_account_type",children:"Account Type *"}),e.jsxs(S,{value:c.account_type,onValueChange:a=>d({...c,account_type:a}),children:[e.jsx(T,{children:e.jsx(F,{placeholder:"Select type"})}),e.jsx(I,{children:v.map(a=>e.jsx(y,{value:a.value,children:a.label},a.value))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"edit_account_name",children:"Account Name *"}),e.jsx(N,{id:"edit_account_name",value:c.account_name,onChange:a=>d({...c,account_name:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"edit_description",children:"Description"}),e.jsx(Z,{id:"edit_description",value:c.description,onChange:a=>d({...c,description:a.target.value}),rows:3})]})]}),e.jsxs(ee,{children:[e.jsx(x,{variant:"outline",onClick:()=>f(null),children:"Cancel"}),e.jsx(x,{onClick:K,disabled:z.isPending,children:"Save Changes"})]})]})})]})}export{qe as default};
