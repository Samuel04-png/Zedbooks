import{c as re,j as e,a as ie,C as le,B as C,R as oe,u as de,r as R,b as P,d as xe,L as me,E as H,e as z,f as y,g as N,h as _,i as v,k as K,I as W,T as he,l as ue,m as T,n as je,o as ge,F as pe,p as w,D as S,q as B,s as E,t as c,v as d,w as L,x as s,y as Z}from"./index-B36Zt7Jb.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=re("ChartPie",[["path",{d:"M21 12c.552 0 1.005-.449.95-.998a10 10 0 0 0-8.953-8.951c-.55-.055-.998.398-.998.95v8a1 1 0 0 0 1 1z",key:"pzmjnu"}],["path",{d:"M21.21 15.89A10 10 0 1 1 8 2.83",key:"k2fpak"}]]);function V({icon:a,title:n="Something went wrong",message:r="An error occurred while loading the data. Please try again.",onRetry:i,retryLabel:j="Try Again",className:b}){return e.jsxs("div",{className:ie("flex flex-col items-center justify-center py-12 px-4 text-center",b),children:[e.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-destructive/10",children:a||e.jsx(le,{className:"h-8 w-8 text-destructive"})}),e.jsx("h3",{className:"text-lg font-semibold",children:n}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground max-w-sm",children:r}),i&&e.jsxs(C,{onClick:i,variant:"outline",className:"mt-4",children:[e.jsx(oe,{className:"mr-2 h-4 w-4"}),j]})]})}const fe=a=>{const n=a.toLowerCase();return n==="revenue"?"income":n==="asset"||n==="liability"||n==="equity"||n==="income"||n==="expense"?n:"expense"},ye=a=>a==="asset"||a==="expense",Ne=(a,n,r)=>ye(a)?n-r:r-n,Y=a=>a.map(n=>{const r=fe(n.accountType),i=Number(n.debitTotal??0),j=Number(n.creditTotal??0);return{account_id:n.accountId,account_code:String(n.accountCode??""),account_name:String(n.accountName??""),account_type:r,debit_total:i,credit_total:j,balance:Ne(r,i,j)}}).sort((n,r)=>n.account_code.localeCompare(r.account_code)),f=(a,n)=>a.filter(r=>r.account_type===n).reduce((r,i)=>r+i.balance,0),l=a=>new Intl.NumberFormat("en-ZM",{style:"currency",currency:"ZMW",minimumFractionDigits:2,maximumFractionDigits:2}).format(a),_e=a=>a==null?"":String(a).replaceAll('"','""'),k=(a,n)=>{if(!a.length)return;const r=Object.keys(a[0]),i=a.map(h=>r.map(u=>`"${_e(h[u])}"`).join(",")),j=[r.join(","),...i].join(`
`),b=new Blob([j],{type:"text/csv"}),m=window.URL.createObjectURL(b),x=document.createElement("a");x.href=m,x.download=`${n}.csv`,x.click(),window.URL.revokeObjectURL(m)},Te=()=>{const{user:a}=de(),[n,r]=R.useState(()=>{const t=new Date;return t.setMonth(t.getMonth()-1),t.toISOString().split("T")[0]}),[i,j]=R.useState(new Date().toISOString().split("T")[0]),b=n<=i,m=P({queryKey:["financial-reports-company-id",a==null?void 0:a.id],queryFn:async()=>{if(!a)return null;const t=await xe.getPrimaryMembershipByUser(a.id);return(t==null?void 0:t.companyId)??null},enabled:!!a}),x=m.data??null,h=P({queryKey:["financial-reports-gl-period",x,n,i],queryFn:()=>Z.getGLBalances({companyId:x,startDate:n,endDate:i}),enabled:!!x&&b}),u=P({queryKey:["financial-reports-gl-as-of",x,i],queryFn:()=>Z.getGLBalances({companyId:x,startDate:"1900-01-01",endDate:i}),enabled:!!x&&b}),J=m.isLoading||h.isLoading||u.isLoading,X=m.isError||h.isError||u.isError,g=R.useMemo(()=>Y(h.data??[]),[h.data]),p=R.useMemo(()=>Y(u.data??[]),[u.data]),ee=g.filter(t=>t.account_type==="income"),te=g.filter(t=>t.account_type==="expense"),D=f(g,"income"),I=f(g,"expense"),F=D-I,G=f(p,"asset"),q=f(p,"liability"),se=f(p,"equity"),ae=f(p,"income")-f(p,"expense"),M=se+ae,U=p.filter(t=>t.account_type==="asset"&&/cash|bank/i.test(t.account_name)).reduce((t,o)=>t+o.balance,0),O=g.filter(t=>t.account_type==="asset"&&/cash|bank/i.test(t.account_name)).reduce((t,o)=>t+o.balance,0),Q=ee.reduce((t,o)=>t+o.credit_total,0),$=te.reduce((t,o)=>t+o.debit_total,0),A=p.map(t=>{const o=t.debit_total-t.credit_total;return{...t,debit_balance:o>0?o:0,credit_balance:o<0?Math.abs(o):0}}),ne=A.reduce((t,o)=>t+o.debit_balance,0),ce=A.reduce((t,o)=>t+o.credit_balance,0);if(!b)return e.jsx(V,{title:"Invalid date range",message:"Start date must be before or equal to end date."});if(!a)return e.jsx(V,{title:"Not authenticated",message:"Sign in to view financial reports."});if(J)return e.jsx(me,{message:"Building reports from the general ledger...",className:"py-20"});if(!x)return e.jsx(H,{title:"No company membership found",description:"Your account is not linked to an active company.",icon:e.jsx(z,{className:"h-8 w-8 text-muted-foreground"})});if(X){const t=m.error instanceof Error?m.error.message:h.error instanceof Error?h.error.message:u.error instanceof Error?u.error.message:void 0;return e.jsx(V,{title:"Failed to load financial reports",message:t,onRetry:()=>{m.refetch(),h.refetch(),u.refetch()}})}return!g.length&&!p.length?e.jsx(H,{title:"No posted journal entries found",description:"Post journal entries first. Financial reports are generated directly from the general ledger.",icon:e.jsx(z,{className:"h-8 w-8 text-muted-foreground"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight",children:"Financial Reports"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"All statements below are generated from posted general ledger journal lines only."})]}),e.jsxs(y,{children:[e.jsx(N,{children:e.jsx(_,{children:"Report Period"})}),e.jsx(v,{children:e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 lg:max-w-xl",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{htmlFor:"report-start-date",children:"Start Date"}),e.jsx(W,{id:"report-start-date",type:"date",value:n,onChange:t=>r(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{htmlFor:"report-end-date",children:"End Date"}),e.jsx(W,{id:"report-end-date",type:"date",value:i,onChange:t=>j(t.target.value)})]})]})})]}),e.jsxs(he,{defaultValue:"income-statement",children:[e.jsxs(ue,{className:"grid w-full grid-cols-2 md:grid-cols-5",children:[e.jsxs(T,{value:"income-statement",children:[e.jsx(je,{className:"mr-2 h-4 w-4"}),"Income Statement"]}),e.jsxs(T,{value:"balance-sheet",children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Balance Sheet"]}),e.jsxs(T,{value:"cash-flow",children:[e.jsx(ge,{className:"mr-2 h-4 w-4"}),"Cash Flow"]}),e.jsxs(T,{value:"trial-balance",children:[e.jsx(pe,{className:"mr-2 h-4 w-4"}),"Trial Balance"]}),e.jsxs(T,{value:"general-ledger",children:[e.jsx(z,{className:"mr-2 h-4 w-4"}),"GL Summary"]})]}),e.jsx(w,{value:"income-statement",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsx(_,{children:"Income Statement (GL-based)"}),e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>k([{category:"Revenue",amount:D},{category:"Expenses",amount:I},{category:"Net Income",amount:F}],"income-statement"),children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(v,{children:e.jsxs(B,{children:[e.jsx(E,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Category"}),e.jsx(d,{className:"text-right",children:"Amount"})]})}),e.jsxs(L,{children:[e.jsxs(c,{className:"font-medium",children:[e.jsx(s,{children:"Total Revenue"}),e.jsx(s,{className:"text-right text-green-600",children:l(D)})]}),e.jsxs(c,{className:"font-medium",children:[e.jsx(s,{children:"Total Expenses"}),e.jsxs(s,{className:"text-right text-red-600",children:["(",l(I),")"]})]}),e.jsxs(c,{className:"font-semibold bg-muted/40",children:[e.jsx(s,{children:"Net Income"}),e.jsx(s,{className:`text-right ${F>=0?"text-green-600":"text-red-600"}`,children:l(F)})]})]})]})})]})}),e.jsx(w,{value:"balance-sheet",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsxs(_,{children:["Balance Sheet (as of ",i,")"]}),e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>k([{section:"Assets",amount:G},{section:"Liabilities",amount:q},{section:"Equity",amount:M}],"balance-sheet"),children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(v,{children:e.jsxs(B,{children:[e.jsx(E,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Section"}),e.jsx(d,{className:"text-right",children:"Amount"})]})}),e.jsxs(L,{children:[e.jsxs(c,{children:[e.jsx(s,{children:"Total Assets"}),e.jsx(s,{className:"text-right",children:l(G)})]}),e.jsxs(c,{children:[e.jsx(s,{children:"Total Liabilities"}),e.jsx(s,{className:"text-right",children:l(q)})]}),e.jsxs(c,{children:[e.jsx(s,{children:"Total Equity (includes retained earnings)"}),e.jsx(s,{className:"text-right",children:l(M)})]}),e.jsxs(c,{className:"font-semibold bg-muted/40",children:[e.jsx(s,{children:"Liabilities + Equity"}),e.jsx(s,{className:"text-right",children:l(q+M)})]})]})]})})]})}),e.jsx(w,{value:"cash-flow",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsx(_,{children:"Cash Flow Summary (GL-derived)"}),e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>k([{metric:"Operating Inflow Proxy",amount:Q},{metric:"Operating Outflow Proxy",amount:$},{metric:"Net Cash Movement (Cash/Bank Accounts)",amount:O},{metric:"Closing Cash Balance",amount:U}],"cash-flow-summary"),children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsxs(v,{className:"space-y-4",children:[e.jsxs(B,{children:[e.jsx(E,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Metric"}),e.jsx(d,{className:"text-right",children:"Amount"})]})}),e.jsxs(L,{children:[e.jsxs(c,{children:[e.jsx(s,{children:"Operating Inflow Proxy"}),e.jsx(s,{className:"text-right text-green-600",children:l(Q)})]}),e.jsxs(c,{children:[e.jsx(s,{children:"Operating Outflow Proxy"}),e.jsxs(s,{className:"text-right text-red-600",children:["(",l($),")"]})]}),e.jsxs(c,{children:[e.jsx(s,{children:"Net Cash Movement (Cash/Bank Accounts)"}),e.jsx(s,{className:`text-right ${O>=0?"text-green-600":"text-red-600"}`,children:l(O)})]}),e.jsxs(c,{className:"font-semibold bg-muted/40",children:[e.jsx(s,{children:"Closing Cash Balance"}),e.jsx(s,{className:"text-right",children:l(U)})]})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:'Cash balances are derived from asset accounts with names containing "cash" or "bank".'})]})]})}),e.jsx(w,{value:"trial-balance",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsxs(_,{children:["Trial Balance (as of ",i,")"]}),e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>k(A.map(t=>({account_code:t.account_code,account_name:t.account_name,debit:t.debit_balance,credit:t.credit_balance})),"trial-balance"),children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(v,{children:e.jsxs(B,{children:[e.jsx(E,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Account"}),e.jsx(d,{className:"text-right",children:"Debit"}),e.jsx(d,{className:"text-right",children:"Credit"})]})}),e.jsxs(L,{children:[A.map(t=>e.jsxs(c,{children:[e.jsxs(s,{children:[t.account_code," - ",t.account_name]}),e.jsx(s,{className:"text-right",children:t.debit_balance>0?l(t.debit_balance):"-"}),e.jsx(s,{className:"text-right",children:t.credit_balance>0?l(t.credit_balance):"-"})]},t.account_id)),e.jsxs(c,{className:"font-semibold bg-muted/40",children:[e.jsx(s,{children:"Totals"}),e.jsx(s,{className:"text-right",children:l(ne)}),e.jsx(s,{className:"text-right",children:l(ce)})]})]})]})})]})}),e.jsx(w,{value:"general-ledger",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsx(_,{children:"General Ledger Account Movements"}),e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>k(g.map(t=>({account_code:t.account_code,account_name:t.account_name,account_type:t.account_type,debit_total:t.debit_total,credit_total:t.credit_total,balance:t.balance})),"general-ledger-summary"),children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(v,{children:e.jsxs(B,{children:[e.jsx(E,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Account"}),e.jsx(d,{children:"Type"}),e.jsx(d,{className:"text-right",children:"Debits"}),e.jsx(d,{className:"text-right",children:"Credits"}),e.jsx(d,{className:"text-right",children:"Balance"})]})}),e.jsx(L,{children:g.map(t=>e.jsxs(c,{children:[e.jsxs(s,{children:[t.account_code," - ",t.account_name]}),e.jsx(s,{className:"capitalize",children:t.account_type}),e.jsx(s,{className:"text-right",children:l(t.debit_total)}),e.jsx(s,{className:"text-right",children:l(t.credit_total)}),e.jsx(s,{className:"text-right",children:l(t.balance)})]},t.account_id))})]})})]})})]})]})};export{Te as default};
