import{z as ce,u as ie,r as H,A as O,b as Q,d as W,G as I,H as Y,J as G,K as U,M as de,j as e,k as me,I as he,f as y,g,h as f,i as N,N as c,T as xe,l as pe,m as w,p as v,B as M,D as R,q as T,s as D,t as E,v as i,w as _,x as o,F as ue,O as $,P as q}from"./index-muEzpKpP.js";const je=j=>{if(!j)return null;const d=new Date(String(j));return Number.isNaN(d.getTime())?null:d.toISOString().slice(0,10)},ye=(j,d)=>{if(!j.length)return[];const x=[];for(let S=0;S<j.length;S+=d)x.push(j.slice(S,S+d));return x},Ne=j=>{const d=String(j||"").toLowerCase().trim();return d==="approved"?"processed":d==="completed"?"paid":["draft","trial","processed","paid","payment_reversed","reversed","final"].includes(d)?d:"draft"};function ge(){const j=ce(),{user:d}=ie(),[x,S]=H.useState(O(new Date,"yyyy-MM")),[A,Z]=H.useState(!1),X=`${x}-01`,ee=new Date(parseInt(x.split("-")[0],10),parseInt(x.split("-")[1],10),0).toISOString().split("T")[0],{data:V,isLoading:se}=Q({queryKey:["payroll-runs-report",x,d==null?void 0:d.id],queryFn:async()=>{if(!d)return[];const s=await W.getPrimaryMembershipByUser(d.id);if(!(s!=null&&s.companyId))return[];const l=I(q,$.PAYROLL_RUNS);return(await Y(G(l,U("companyId","==",s.companyId)))).docs.map(h=>{const m=h.data(),b=m.runDate??m.run_date;return{id:h.id,runDate:b?String(b):"",status:Ne(m.payrollStatus??m.payroll_status??m.status)}}).filter(h=>{const m=je(h.runDate);return!!(m&&m>=X&&m<=ee)}).sort((h,m)=>String(m.runDate).localeCompare(String(h.runDate)))},enabled:!!d}),P=H.useMemo(()=>new Set((V||[]).filter(s=>A||s.status!=="reversed").map(s=>s.id)),[V,A]),{data:a}=Q({queryKey:["payroll-items-report",x,d==null?void 0:d.id,A?"with-reversed":"without-reversed",Array.from(P).join("|")],queryFn:async()=>{if(!d||P.size===0)return[];const s=await W.getPrimaryMembershipByUser(d.id);if(!(s!=null&&s.companyId))return[];const l=I(q,$.PAYROLL_ITEMS),r=(await Y(G(l,U("companyId","==",s.companyId)))).docs.map(p=>{const t=p.data();return{id:p.id,payrollRunId:String(t.payrollRunId??t.payroll_run_id??""),employeeId:String(t.employeeId??t.employee_id??""),basicSalary:Number(t.basicSalary??t.basic_salary??0),housingAllowance:Number(t.housingAllowance??t.housing_allowance??0),transportAllowance:Number(t.transportAllowance??t.transport_allowance??0),otherAllowances:Number(t.otherAllowances??t.other_allowances??0),grossSalary:Number(t.grossSalary??t.gross_salary??0),paye:Number(t.paye??0),napsaEmployee:Number(t.napsaEmployee??t.napsa_employee??0),napsaEmployer:Number(t.napsaEmployer??t.napsa_employer??0),nhimaEmployee:Number(t.nhimaEmployee??t.nhima_employee??0),nhimaEmployer:Number(t.nhimaEmployer??t.nhima_employer??0),advancesDeducted:Number(t.advancesDeducted??t.advances_deducted??0),totalDeductions:Number(t.totalDeductions??t.total_deductions??0),netSalary:Number(t.netSalary??t.net_salary??0)}}).filter(p=>p.payrollRunId&&P.has(p.payrollRunId)),h=Array.from(new Set(r.map(p=>p.employeeId).filter(Boolean))),m=new Map,b=ye(h,30);if(b.length>0){const p=I(q,$.EMPLOYEES);(await Promise.all(b.map(B=>Y(G(p,U(de(),"in",B)))))).forEach(B=>{B.docs.forEach(J=>{const u=J.data();m.set(J.id,{fullName:String(u.fullName??u.full_name??""),employeeNumber:String(u.employeeNumber??u.employee_number??""),tpin:String(u.tpin??""),napsaNumber:String(u.napsaNumber??u.napsa_number??""),nhimaNumber:String(u.nhimaNumber??u.nhima_number??""),position:String(u.position??""),department:String(u.department??"")})})})}return r.map(p=>({...p,employees:m.get(p.employeeId)??null}))},enabled:!!(d&&P.size>0)}),C=(s,l,n)=>{const r=[s,...l].map(p=>p.join(",")).join(`
`),h=new Blob([r],{type:"text/csv"}),m=window.URL.createObjectURL(h),b=document.createElement("a");b.href=m,b.download=n,b.click(),window.URL.revokeObjectURL(m)},ae=()=>{if(!a||a.length===0)return;const s=["Employee Number","Employee Name","Position","Department","Basic Salary","Housing Allowance","Transport Allowance","Other Allowances","Gross Salary","PAYE","NAPSA Employee","NHIMA Employee","Advances Deducted","Total Deductions","Net Salary"],l=a.map(n=>{const r=n.employees;return[(r==null?void 0:r.employeeNumber)??"",(r==null?void 0:r.fullName)??"",(r==null?void 0:r.position)||"",(r==null?void 0:r.department)||"",n.basicSalary,n.housingAllowance,n.transportAllowance,n.otherAllowances,n.grossSalary,n.paye,n.napsaEmployee,n.nhimaEmployee,n.advancesDeducted,n.totalDeductions,n.netSalary]});C(s,l,`master-payroll-${x}.csv`)},re=()=>{if(!a||a.length===0)return;const s=["Employee Number","Employee Name","NAPSA Number","Gross Salary","Employee Contribution (5%)","Employer Contribution (5%)","Total Contribution"],l=a.map(n=>{const r=n.employees,h=n.napsaEmployee,m=n.napsaEmployer;return[(r==null?void 0:r.employeeNumber)??"",(r==null?void 0:r.fullName)??"",(r==null?void 0:r.napsaNumber)||"",n.grossSalary,h,m,h+m]});C(s,l,`napsa-report-${x}.csv`)},ne=()=>{if(!a||a.length===0)return;const s=["Employee Number","Employee Name","NHIMA Number","Basic Salary","Employee Contribution (1%)","Employer Contribution (1%)","Total Contribution"],l=a.map(n=>{const r=n.employees,h=n.nhimaEmployee,m=n.nhimaEmployer;return[(r==null?void 0:r.employeeNumber)??"",(r==null?void 0:r.fullName)??"",(r==null?void 0:r.nhimaNumber)||"",n.basicSalary,h,m,h+m]});C(s,l,`nhima-report-${x}.csv`)},le=()=>{if(!a||a.length===0)return;const s=["Employee Number","Employee Name","TPIN","Gross Salary","PAYE Amount"],l=a.map(n=>{const r=n.employees;return[(r==null?void 0:r.employeeNumber)??"",(r==null?void 0:r.fullName)??"",(r==null?void 0:r.tpin)||"",n.grossSalary,n.paye]});C(s,l,`paye-report-${x}.csv`)},te=(a==null?void 0:a.reduce((s,l)=>s+l.grossSalary,0))||0,oe=(a==null?void 0:a.reduce((s,l)=>s+l.netSalary,0))||0,z=(a==null?void 0:a.reduce((s,l)=>s+l.paye,0))||0,L=(a==null?void 0:a.reduce((s,l)=>s+l.napsaEmployee,0))||0,k=(a==null?void 0:a.reduce((s,l)=>s+l.napsaEmployer,0))||0,F=(a==null?void 0:a.reduce((s,l)=>s+l.nhimaEmployee,0))||0,K=(a==null?void 0:a.reduce((s,l)=>s+l.nhimaEmployer,0))||0;return se?e.jsx("div",{children:"Loading..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Payroll Reports"}),e.jsx("p",{className:"text-muted-foreground",children:"Comprehensive payroll analysis and statutory reports"})]})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"w-48",children:[e.jsx(me,{children:"Select Month"}),e.jsx(he,{type:"month",value:x,onChange:s=>S(s.target.value)})]}),e.jsxs("label",{className:"flex items-center gap-2 pt-6 text-sm",children:[e.jsx("input",{type:"checkbox",checked:A,onChange:s=>Z(s.target.checked)}),"Include reversed payroll runs"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(y,{children:[e.jsx(g,{className:"pb-2",children:e.jsx(f,{className:"text-sm font-medium",children:"Total Gross"})}),e.jsx(N,{children:e.jsx("div",{className:"text-2xl font-bold",children:c(te)})})]}),e.jsxs(y,{children:[e.jsx(g,{className:"pb-2",children:e.jsx(f,{className:"text-sm font-medium",children:"Total PAYE"})}),e.jsx(N,{children:e.jsx("div",{className:"text-2xl font-bold",children:c(z)})})]}),e.jsxs(y,{children:[e.jsx(g,{className:"pb-2",children:e.jsx(f,{className:"text-sm font-medium",children:"Total NAPSA"})}),e.jsxs(N,{children:[e.jsx("div",{className:"text-2xl font-bold",children:c(L+k)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Employee + Employer"})]})]}),e.jsxs(y,{children:[e.jsx(g,{className:"pb-2",children:e.jsx(f,{className:"text-sm font-medium",children:"Total Net Pay"})}),e.jsx(N,{children:e.jsx("div",{className:"text-2xl font-bold",children:c(oe)})})]})]}),e.jsxs(xe,{defaultValue:"master",className:"space-y-4",children:[e.jsxs(pe,{children:[e.jsx(w,{value:"master",children:"Master Payroll"}),e.jsx(w,{value:"payslips",children:"Individual Payslips"}),e.jsx(w,{value:"napsa",children:"NAPSA Report"}),e.jsx(w,{value:"nhima",children:"NHIMA Report"}),e.jsx(w,{value:"paye",children:"PAYE Report"})]}),e.jsx(v,{value:"master",children:e.jsxs(y,{children:[e.jsxs(g,{className:"flex flex-row items-center justify-between",children:[e.jsxs(f,{children:["Master Payroll - ",O(new Date(x+"-01"),"MMMM yyyy")]}),e.jsxs(M,{onClick:ae,disabled:!(a!=null&&a.length),children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(N,{children:e.jsxs(T,{children:[e.jsx(D,{children:e.jsxs(E,{children:[e.jsx(i,{children:"Emp #"}),e.jsx(i,{children:"Name"}),e.jsx(i,{children:"Position"}),e.jsx(i,{className:"text-right",children:"Basic"}),e.jsx(i,{className:"text-right",children:"Gross"}),e.jsx(i,{className:"text-right",children:"Deductions"}),e.jsx(i,{className:"text-right",children:"Net Pay"})]})}),e.jsxs(_,{children:[a==null?void 0:a.map(s=>{var l,n,r;return e.jsxs(E,{children:[e.jsx(o,{children:(l=s.employees)==null?void 0:l.employeeNumber}),e.jsx(o,{children:(n=s.employees)==null?void 0:n.fullName}),e.jsx(o,{children:((r=s.employees)==null?void 0:r.position)||"-"}),e.jsx(o,{className:"text-right",children:c(s.basicSalary)}),e.jsx(o,{className:"text-right",children:c(s.grossSalary)}),e.jsx(o,{className:"text-right",children:c(s.totalDeductions)}),e.jsx(o,{className:"text-right font-semibold",children:c(s.netSalary)})]},s.id)}),(!a||a.length===0)&&e.jsx(E,{children:e.jsx(o,{colSpan:7,className:"text-center text-muted-foreground",children:"No payroll data for selected month"})})]})]})})]})}),e.jsx(v,{value:"payslips",children:e.jsxs(y,{children:[e.jsx(g,{children:e.jsxs(f,{children:["Individual Payslips - ",O(new Date(x+"-01"),"MMMM yyyy")]})}),e.jsx(N,{children:e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[a==null?void 0:a.map(s=>{var l,n;return e.jsx(y,{className:"cursor-pointer hover:bg-muted/50 transition-colors",onClick:()=>j(`/payroll/${s.payrollRunId}/payslip/${s.employeeId}`),children:e.jsxs(N,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:(l=s.employees)==null?void 0:l.fullName}),e.jsx("p",{className:"text-sm text-muted-foreground",children:(n=s.employees)==null?void 0:n.employeeNumber})]}),e.jsx(ue,{className:"h-5 w-5 text-muted-foreground"})]}),e.jsxs("div",{className:"mt-2 pt-2 border-t",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Net Pay"}),e.jsx("p",{className:"text-lg font-bold",children:c(s.netSalary)})]})]})},s.id)}),(!a||a.length===0)&&e.jsx("p",{className:"text-muted-foreground col-span-full text-center py-8",children:"No payroll data for selected month"})]})})]})}),e.jsx(v,{value:"napsa",children:e.jsxs(y,{children:[e.jsxs(g,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(f,{children:"NAPSA Contributions Report"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Total: ",c(L+k)," (Employee: ",c(L)," + Employer: ",c(k),")"]})]}),e.jsxs(M,{onClick:re,disabled:!(a!=null&&a.length),children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(N,{children:e.jsxs(T,{children:[e.jsx(D,{children:e.jsxs(E,{children:[e.jsx(i,{children:"Emp #"}),e.jsx(i,{children:"Name"}),e.jsx(i,{children:"NAPSA Number"}),e.jsx(i,{className:"text-right",children:"Gross Salary"}),e.jsx(i,{className:"text-right",children:"Employee (5%)"}),e.jsx(i,{className:"text-right",children:"Employer (5%)"}),e.jsx(i,{className:"text-right",children:"Total"})]})}),e.jsx(_,{children:a==null?void 0:a.map(s=>{var l,n,r;return e.jsxs(E,{children:[e.jsx(o,{children:(l=s.employees)==null?void 0:l.employeeNumber}),e.jsx(o,{children:(n=s.employees)==null?void 0:n.fullName}),e.jsx(o,{children:((r=s.employees)==null?void 0:r.napsaNumber)||"-"}),e.jsx(o,{className:"text-right",children:c(s.grossSalary)}),e.jsx(o,{className:"text-right",children:c(s.napsaEmployee)}),e.jsx(o,{className:"text-right",children:c(s.napsaEmployer)}),e.jsx(o,{className:"text-right font-semibold",children:c(s.napsaEmployee+s.napsaEmployer)})]},s.id)})})]})})]})}),e.jsx(v,{value:"nhima",children:e.jsxs(y,{children:[e.jsxs(g,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(f,{children:"NHIMA Contributions Report"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Total: ",c(F+K)," (Employee: ",c(F)," + Employer: ",c(K),")"]})]}),e.jsxs(M,{onClick:ne,disabled:!(a!=null&&a.length),children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(N,{children:e.jsxs(T,{children:[e.jsx(D,{children:e.jsxs(E,{children:[e.jsx(i,{children:"Emp #"}),e.jsx(i,{children:"Name"}),e.jsx(i,{children:"NHIMA Number"}),e.jsx(i,{className:"text-right",children:"Basic Salary"}),e.jsx(i,{className:"text-right",children:"Employee (1%)"}),e.jsx(i,{className:"text-right",children:"Employer (1%)"}),e.jsx(i,{className:"text-right",children:"Total"})]})}),e.jsx(_,{children:a==null?void 0:a.map(s=>{var l,n,r;return e.jsxs(E,{children:[e.jsx(o,{children:(l=s.employees)==null?void 0:l.employeeNumber}),e.jsx(o,{children:(n=s.employees)==null?void 0:n.fullName}),e.jsx(o,{children:((r=s.employees)==null?void 0:r.nhimaNumber)||"-"}),e.jsx(o,{className:"text-right",children:c(s.basicSalary)}),e.jsx(o,{className:"text-right",children:c(s.nhimaEmployee)}),e.jsx(o,{className:"text-right",children:c(s.nhimaEmployer)}),e.jsx(o,{className:"text-right font-semibold",children:c(s.nhimaEmployee+s.nhimaEmployer)})]},s.id)})})]})})]})}),e.jsx(v,{value:"paye",children:e.jsxs(y,{children:[e.jsxs(g,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(f,{children:"PAYE Report"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Total PAYE: ",c(z)]})]}),e.jsxs(M,{onClick:le,disabled:!(a!=null&&a.length),children:[e.jsx(R,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(N,{children:e.jsxs(T,{children:[e.jsx(D,{children:e.jsxs(E,{children:[e.jsx(i,{children:"Emp #"}),e.jsx(i,{children:"Name"}),e.jsx(i,{children:"TPIN"}),e.jsx(i,{className:"text-right",children:"Gross Salary"}),e.jsx(i,{className:"text-right",children:"PAYE Amount"})]})}),e.jsx(_,{children:a==null?void 0:a.map(s=>{var l,n,r;return e.jsxs(E,{children:[e.jsx(o,{children:(l=s.employees)==null?void 0:l.employeeNumber}),e.jsx(o,{children:(n=s.employees)==null?void 0:n.fullName}),e.jsx(o,{children:((r=s.employees)==null?void 0:r.tpin)||"-"}),e.jsx(o,{className:"text-right",children:c(s.grossSalary)}),e.jsx(o,{className:"text-right font-semibold",children:c(s.paye)})]},s.id)})})]})})]})})]})]})}export{ge as default};
