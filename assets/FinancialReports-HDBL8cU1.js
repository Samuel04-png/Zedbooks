import{c as re,j as e,a as le,C as ie,B as _,R as oe,u as de,r as D,b as V,d as xe,L as me,E as W,e as G,f as y,g as N,h as v,i as C,k as Z,I as Y,T as he,l as ue,m as w,n as je,o as ge,F as pe,p as B,D as T,q as S,s as L,t as c,v as d,w as E,x as s,y as J}from"./index-BxWJIJIv.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=re("ChartPie",[["path",{d:"M21 12c.552 0 1.005-.449.95-.998a10 10 0 0 0-8.953-8.951c-.55-.055-.998.398-.998.95v8a1 1 0 0 0 1 1z",key:"pzmjnu"}],["path",{d:"M21.21 15.89A10 10 0 1 1 8 2.83",key:"k2fpak"}]]);function U({icon:a,title:n="Something went wrong",message:l="An error occurred while loading the data. Please try again.",onRetry:i,retryLabel:j="Try Again",className:f}){return e.jsxs("div",{className:le("flex flex-col items-center justify-center py-12 px-4 text-center",f),children:[e.jsx("div",{className:"mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-destructive/10",children:a||e.jsx(ie,{className:"h-8 w-8 text-destructive"})}),e.jsx("h3",{className:"text-lg font-semibold",children:n}),e.jsx("p",{className:"mt-1 text-sm text-muted-foreground max-w-sm",children:l}),i&&e.jsxs(_,{onClick:i,variant:"outline",className:"mt-4",children:[e.jsx(oe,{className:"mr-2 h-4 w-4"}),j]})]})}const be=a=>{const n=a.toLowerCase();return n==="revenue"?"income":n==="asset"||n==="liability"||n==="equity"||n==="income"||n==="expense"?n:"expense"},ye=a=>a==="asset"||a==="expense",Ne=(a,n,l)=>ye(a)?n-l:l-n,X=a=>a.map(n=>{const l=be(n.accountType),i=Number(n.debitTotal??0),j=Number(n.creditTotal??0);return{account_id:n.accountId,account_code:String(n.accountCode??""),account_name:String(n.accountName??""),account_type:l,debit_total:i,credit_total:j,balance:Ne(l,i,j)}}).sort((n,l)=>n.account_code.localeCompare(l.account_code)),b=(a,n)=>a.filter(l=>l.account_type===n).reduce((l,i)=>l+i.balance,0),r=a=>new Intl.NumberFormat("en-ZM",{style:"currency",currency:"ZMW",minimumFractionDigits:2,maximumFractionDigits:2}).format(a),ve=a=>a==null?"":String(a).replace(/"/g,'""'),k=(a,n)=>{if(!a.length)return;const l=Object.keys(a[0]),i=a.map(h=>l.map(u=>`"${ve(h[u])}"`).join(",")),j=[l.join(","),...i].join(`
`),f=new Blob([j],{type:"text/csv"}),m=window.URL.createObjectURL(f),x=document.createElement("a");x.href=m,x.download=`${n}.csv`,x.click(),window.URL.revokeObjectURL(m)},we=()=>{const{user:a}=de(),[n,l]=D.useState(()=>{const t=new Date;return t.setMonth(t.getMonth()-1),t.toISOString().split("T")[0]}),[i,j]=D.useState(new Date().toISOString().split("T")[0]),f=n<=i,m=V({queryKey:["financial-reports-company-id",a==null?void 0:a.id],queryFn:async()=>{if(!a)return null;const t=await xe.getPrimaryMembershipByUser(a.id);return(t==null?void 0:t.companyId)??null},enabled:!!a}),x=m.data??null,h=V({queryKey:["financial-reports-gl-period",x,n,i],queryFn:()=>J.getGLBalances({companyId:x,startDate:n,endDate:i}),enabled:!!x&&f}),u=V({queryKey:["financial-reports-gl-as-of",x,i],queryFn:()=>J.getGLBalances({companyId:x,startDate:"1900-01-01",endDate:i}),enabled:!!x&&f}),ee=m.isLoading||h.isLoading||u.isLoading,te=m.isError||h.isError||u.isError,g=D.useMemo(()=>X(h.data??[]),[h.data]),p=D.useMemo(()=>X(u.data??[]),[u.data]),se=g.filter(t=>t.account_type==="income"),ae=g.filter(t=>t.account_type==="expense"),I=b(g,"income"),F=b(g,"expense"),O=I-F,Q=b(p,"asset"),q=b(p,"liability"),ne=b(p,"equity"),ce=b(p,"income")-b(p,"expense"),z=ne+ce,$=p.filter(t=>t.account_type==="asset"&&/cash|bank/i.test(t.account_name)).reduce((t,o)=>t+o.balance,0),P=g.filter(t=>t.account_type==="asset"&&/cash|bank/i.test(t.account_name)).reduce((t,o)=>t+o.balance,0),H=se.reduce((t,o)=>t+o.credit_total,0),K=ae.reduce((t,o)=>t+o.debit_total,0),R=p.map(t=>{const o=t.debit_total-t.credit_total;return{...t,debit_balance:o>0?o:0,credit_balance:o<0?Math.abs(o):0}}),A=R.reduce((t,o)=>t+o.debit_balance,0),M=R.reduce((t,o)=>t+o.credit_balance,0);if(!f)return e.jsx(U,{title:"Invalid date range",message:"Start date must be before or equal to end date."});if(!a)return e.jsx(U,{title:"Not authenticated",message:"Sign in to view financial reports."});if(ee)return e.jsx(me,{message:"Building reports from the general ledger...",className:"py-20"});if(!x)return e.jsx(W,{title:"No company membership found",description:"Your account is not linked to an active company.",icon:e.jsx(G,{className:"h-8 w-8 text-muted-foreground"})});if(te){const t=m.error instanceof Error?m.error.message:h.error instanceof Error?h.error.message:u.error instanceof Error?u.error.message:void 0;return e.jsx(U,{title:"Failed to load financial reports",message:t,onRetry:()=>{m.refetch(),h.refetch(),u.refetch()}})}return!g.length&&!p.length?e.jsx(W,{title:"No posted journal entries found",description:"Post journal entries first. Financial reports are generated directly from the general ledger.",icon:e.jsx(G,{className:"h-8 w-8 text-muted-foreground"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight",children:"Financial Reports"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"All statements below are generated from posted general ledger journal lines only."})]}),e.jsxs(y,{children:[e.jsx(N,{children:e.jsx(v,{children:"Report Period"})}),e.jsx(C,{children:e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2 lg:max-w-xl",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"report-start-date",children:"Start Date"}),e.jsx(Y,{id:"report-start-date",type:"date",value:n,onChange:t=>l(t.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"report-end-date",children:"End Date"}),e.jsx(Y,{id:"report-end-date",type:"date",value:i,onChange:t=>j(t.target.value)})]})]})})]}),e.jsxs(he,{defaultValue:"income-statement",children:[e.jsxs(ue,{className:"grid w-full grid-cols-2 md:grid-cols-5",children:[e.jsxs(w,{value:"income-statement",children:[e.jsx(je,{className:"mr-2 h-4 w-4"}),"Income Statement"]}),e.jsxs(w,{value:"balance-sheet",children:[e.jsx(fe,{className:"mr-2 h-4 w-4"}),"Balance Sheet"]}),e.jsxs(w,{value:"cash-flow",children:[e.jsx(ge,{className:"mr-2 h-4 w-4"}),"Cash Flow"]}),e.jsxs(w,{value:"trial-balance",children:[e.jsx(pe,{className:"mr-2 h-4 w-4"}),"Trial Balance"]}),e.jsxs(w,{value:"general-ledger",children:[e.jsx(G,{className:"mr-2 h-4 w-4"}),"GL Summary"]})]}),e.jsx(B,{value:"income-statement",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsx(v,{children:"Income Statement (GL-based)"}),e.jsxs(_,{variant:"outline",size:"sm",onClick:()=>k([{category:"Revenue",amount:I},{category:"Expenses",amount:F},{category:"Net Income",amount:O}],"income-statement"),children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(C,{children:e.jsxs(S,{children:[e.jsx(L,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Category"}),e.jsx(d,{className:"text-right",children:"Amount"})]})}),e.jsxs(E,{children:[e.jsxs(c,{className:"font-medium",children:[e.jsx(s,{children:"Total Revenue"}),e.jsx(s,{className:"text-right text-green-600",children:r(I)})]}),e.jsxs(c,{className:"font-medium",children:[e.jsx(s,{children:"Total Expenses"}),e.jsxs(s,{className:"text-right text-red-600",children:["(",r(F),")"]})]}),e.jsxs(c,{className:"font-semibold bg-muted/40",children:[e.jsx(s,{children:"Net Income"}),e.jsx(s,{className:`text-right ${O>=0?"text-green-600":"text-red-600"}`,children:r(O)})]})]})]})})]})}),e.jsx(B,{value:"balance-sheet",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsxs(v,{children:["Balance Sheet (as of ",i,")"]}),e.jsxs(_,{variant:"outline",size:"sm",onClick:()=>k([{section:"Assets",amount:Q},{section:"Liabilities",amount:q},{section:"Equity",amount:z}],"balance-sheet"),children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(C,{children:e.jsxs(S,{children:[e.jsx(L,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Section"}),e.jsx(d,{className:"text-right",children:"Amount"})]})}),e.jsxs(E,{children:[e.jsxs(c,{children:[e.jsx(s,{children:"Total Assets"}),e.jsx(s,{className:"text-right",children:r(Q)})]}),e.jsxs(c,{children:[e.jsx(s,{children:"Total Liabilities"}),e.jsx(s,{className:"text-right",children:r(q)})]}),e.jsxs(c,{children:[e.jsx(s,{children:"Total Equity (includes retained earnings)"}),e.jsx(s,{className:"text-right",children:r(z)})]}),e.jsxs(c,{className:"font-semibold bg-muted/40",children:[e.jsx(s,{children:"Liabilities + Equity"}),e.jsx(s,{className:"text-right",children:r(q+z)})]})]})]})})]})}),e.jsx(B,{value:"cash-flow",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsx(v,{children:"Cash Flow Summary (GL-derived)"}),e.jsxs(_,{variant:"outline",size:"sm",onClick:()=>k([{metric:"Operating Inflow Proxy",amount:H},{metric:"Operating Outflow Proxy",amount:K},{metric:"Net Cash Movement (Cash/Bank Accounts)",amount:P},{metric:"Closing Cash Balance",amount:$}],"cash-flow-summary"),children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs(S,{children:[e.jsx(L,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Metric"}),e.jsx(d,{className:"text-right",children:"Amount"})]})}),e.jsxs(E,{children:[e.jsxs(c,{children:[e.jsx(s,{children:"Operating Inflow Proxy"}),e.jsx(s,{className:"text-right text-green-600",children:r(H)})]}),e.jsxs(c,{children:[e.jsx(s,{children:"Operating Outflow Proxy"}),e.jsxs(s,{className:"text-right text-red-600",children:["(",r(K),")"]})]}),e.jsxs(c,{children:[e.jsx(s,{children:"Net Cash Movement (Cash/Bank Accounts)"}),e.jsx(s,{className:`text-right ${P>=0?"text-green-600":"text-red-600"}`,children:r(P)})]}),e.jsxs(c,{className:"font-semibold bg-muted/40",children:[e.jsx(s,{children:"Closing Cash Balance"}),e.jsx(s,{className:"text-right",children:r($)})]})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:'Cash balances are derived from asset accounts with names containing "cash" or "bank".'})]})]})}),e.jsx(B,{value:"trial-balance",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsxs(v,{children:["Trial Balance (as of ",i,")"]}),e.jsxs(_,{variant:"outline",size:"sm",onClick:()=>k(R.map(t=>({account_code:t.account_code,account_name:t.account_name,debit:t.debit_balance,credit:t.credit_balance})),"trial-balance"),children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"mb-4 flex items-center justify-between rounded-lg border p-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"Trial Balance Status:"}),Math.abs(A-M)<.01?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-100 px-3 py-1 text-sm font-semibold text-green-800",children:[e.jsx("svg",{className:"h-4 w-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),"Balanced"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-red-100 px-3 py-1 text-sm font-semibold text-red-800",children:[e.jsx("svg",{className:"h-4 w-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})}),"Out of Balance"]})]}),Math.abs(A-M)>=.01&&e.jsxs("div",{className:"text-sm text-red-600 font-medium",children:["Difference: ",r(Math.abs(A-M))]})]}),e.jsxs(S,{children:[e.jsx(L,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Account"}),e.jsx(d,{className:"text-right",children:"Debit"}),e.jsx(d,{className:"text-right",children:"Credit"})]})}),e.jsxs(E,{children:[R.map(t=>e.jsxs(c,{children:[e.jsxs(s,{children:[t.account_code," - ",t.account_name]}),e.jsx(s,{className:"text-right",children:t.debit_balance>0?r(t.debit_balance):"-"}),e.jsx(s,{className:"text-right",children:t.credit_balance>0?r(t.credit_balance):"-"})]},t.account_id)),e.jsxs(c,{className:"font-semibold bg-muted/40",children:[e.jsx(s,{children:"Totals"}),e.jsx(s,{className:"text-right",children:r(A)}),e.jsx(s,{className:"text-right",children:r(M)})]})]})]})]})]})}),e.jsx(B,{value:"general-ledger",children:e.jsxs(y,{children:[e.jsxs(N,{className:"flex flex-row items-center justify-between",children:[e.jsx(v,{children:"General Ledger Account Movements"}),e.jsxs(_,{variant:"outline",size:"sm",onClick:()=>k(g.map(t=>({account_code:t.account_code,account_name:t.account_name,account_type:t.account_type,debit_total:t.debit_total,credit_total:t.credit_total,balance:t.balance})),"general-ledger-summary"),children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Export CSV"]})]}),e.jsx(C,{children:e.jsxs(S,{children:[e.jsx(L,{children:e.jsxs(c,{children:[e.jsx(d,{children:"Account"}),e.jsx(d,{children:"Type"}),e.jsx(d,{className:"text-right",children:"Debits"}),e.jsx(d,{className:"text-right",children:"Credits"}),e.jsx(d,{className:"text-right",children:"Balance"})]})}),e.jsx(E,{children:g.map(t=>e.jsxs(c,{children:[e.jsxs(s,{children:[t.account_code," - ",t.account_name]}),e.jsx(s,{className:"capitalize",children:t.account_type}),e.jsx(s,{className:"text-right",children:r(t.debit_total)}),e.jsx(s,{className:"text-right",children:r(t.credit_total)}),e.jsx(s,{className:"text-right",children:r(t.balance)})]},t.account_id))})]})})]})})]})]})};export{we as default};
