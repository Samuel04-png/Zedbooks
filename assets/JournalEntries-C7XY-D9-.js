import{u as oe,a0 as ue,r as S,b as z,d as W,G as Q,H as J,J as K,K as B,a1 as me,j as e,k as X,I as E,q as se,s as re,t as R,v as m,w as te,x as d,V as xe,W as he,X as je,Y as pe,Z as A,B as I,a2 as ye,N as p,a3 as fe,O as V,P as $,y as ge,a4 as U,M as ve,f as q,g as O,a5 as k,e as ee,h as F,U as Ne,a6 as be,i as Ce,a7 as we,A as ae,$ as g,a8 as ne,a9 as De,aa as ce,ab as ie,ac as le,ad as de}from"./index-muEzpKpP.js";function Re({onClose:c}){const{user:l}=oe(),y=ue(),[v,D]=S.useState(new Date().toISOString().split("T")[0]),[H,t]=S.useState(""),[P,G]=S.useState(""),[x,o]=S.useState([{accountId:"",debit:0,credit:0,description:""},{accountId:"",debit:0,credit:0,description:""}]),{data:Y=[]}=z({queryKey:["chart-of-accounts",l==null?void 0:l.id],queryFn:async()=>{if(!l)return[];const s=await W.getPrimaryMembershipByUser(l.id);if(!(s!=null&&s.companyId))return[];const n=Q($,V.CHART_OF_ACCOUNTS);return(await J(K(n,B("companyId","==",s.companyId),B("status","==","active")))).docs.map(C=>{const w=C.data();return{id:C.id,accountCode:String(w.accountCode||""),accountName:String(w.accountName||""),accountType:String(w.accountType||"")}}).sort((C,w)=>C.accountCode.localeCompare(w.accountCode))},enabled:!!l}),{data:T}=z({queryKey:["manual-journal-company-id",l==null?void 0:l.id],queryFn:async()=>{if(!l)return null;const s=await W.getPrimaryMembershipByUser(l.id);return(s==null?void 0:s.companyId)??null},enabled:!!l}),h=me({mutationFn:async s=>ge.postJournalEntry(s),onSuccess:()=>{U.success("Manual journal entry created successfully!"),y.invalidateQueries({queryKey:["journal-entries"]}),c()},onError:s=>{const n=s instanceof Error?s.message:"Failed to create journal entry";U.error(n)}}),L=()=>{o([...x,{accountId:"",debit:0,credit:0,description:""}])},_=s=>{x.length>2&&o(x.filter((n,a)=>a!==s))},N=(s,n,a)=>{const C=[...x];n==="debit"||n==="credit"?C[s][n]=Number(a)||0:C[s][n]=a,o(C)},f=x.reduce((s,n)=>s+n.debit,0),b=x.reduce((s,n)=>s+n.credit,0),r=Math.abs(f-b)<.01,i=Math.abs(f-b),u=r&&f>0&&x.every(s=>s.accountId&&(s.debit>0||s.credit>0)&&!(s.debit>0&&s.credit>0)),j=()=>{if(u){if(!T){U.error("No company context found.");return}h.mutate({companyId:T,entryDate:v,referenceNumber:H,description:P,referenceType:"ManualEntry",sourceType:"manual_journal",lines:x.filter(s=>s.accountId&&(s.debit>0||s.credit>0))})}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"entry-date",children:"Entry Date *"}),e.jsx(E,{id:"entry-date",type:"date",value:v,onChange:s=>D(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"reference",children:"Reference Number"}),e.jsx(E,{id:"reference",placeholder:"e.g., ADJ-001",value:H,onChange:s=>t(s.target.value)})]}),e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(X,{htmlFor:"description",children:"Description"}),e.jsx(E,{id:"description",placeholder:"Brief description of entry",value:P,onChange:s=>G(s.target.value)})]})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(se,{children:[e.jsx(re,{children:e.jsxs(R,{children:[e.jsx(m,{className:"w-[300px]",children:"Account"}),e.jsx(m,{children:"Line Description"}),e.jsx(m,{className:"text-right w-[120px]",children:"Debit"}),e.jsx(m,{className:"text-right w-[120px]",children:"Credit"}),e.jsx(m,{className:"w-[50px]"})]})}),e.jsxs(te,{children:[x.map((s,n)=>e.jsxs(R,{children:[e.jsx(d,{children:e.jsxs(xe,{value:s.accountId,onValueChange:a=>N(n,"accountId",a),children:[e.jsx(he,{children:e.jsx(je,{placeholder:"Select account"})}),e.jsx(pe,{children:Y.map(a=>e.jsxs(A,{value:a.id,children:[a.accountCode," - ",a.accountName]},a.id))})]})}),e.jsx(d,{children:e.jsx(E,{placeholder:"Line description",value:s.description,onChange:a=>N(n,"description",a.target.value)})}),e.jsx(d,{children:e.jsx(E,{type:"number",step:"0.01",min:"0",className:"text-right",value:s.debit||"",onChange:a=>N(n,"debit",a.target.value),disabled:s.credit>0})}),e.jsx(d,{children:e.jsx(E,{type:"number",step:"0.01",min:"0",className:"text-right",value:s.credit||"",onChange:a=>N(n,"credit",a.target.value),disabled:s.debit>0})}),e.jsx(d,{children:e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>_(n),disabled:x.length<=2,children:e.jsx(ye,{className:"h-4 w-4 text-destructive"})})})]},n)),e.jsxs(R,{className:"bg-muted/50",children:[e.jsx(d,{colSpan:2,className:"font-semibold",children:"Total"}),e.jsx(d,{className:"text-right font-semibold",children:p(f)}),e.jsx(d,{className:"text-right font-semibold",children:p(b)}),e.jsx(d,{})]})]})]})}),e.jsxs(I,{variant:"outline",onClick:L,className:"w-full gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),"Add Line"]}),e.jsx("div",{className:`p-4 rounded-lg border-2 ${r?"bg-green-50 border-green-500 text-green-700":"bg-red-50 border-red-500 text-red-700"}`,children:r?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Entry is balanced"}),e.jsxs("span",{children:["Debits = Credits = ",p(f)]})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-semibold",children:"Warning: Entry is not balanced"}),e.jsxs("div",{className:"text-sm",children:["Debits: ",p(f)," | Credits: ",p(b)," | Difference: ",p(i)]})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(I,{variant:"outline",onClick:c,disabled:h.isPending,children:"Cancel"}),e.jsx(I,{onClick:j,disabled:!u||h.isPending,children:h.isPending?"Posting...":"Post Entry"})]})]})}const Se=(c,l)=>{const y=[];for(let v=0;v<c.length;v+=l)y.push(c.slice(v,v+l));return y},Ie=c=>{if(!c)return"";if(typeof c=="string")return c;if(c instanceof Date)return c.toISOString();if(typeof c=="object"&&c!==null&&"toDate"in c){const l=c;if(typeof l.toDate=="function")return l.toDate().toISOString()}return""};function Ee(){const{user:c}=oe(),l=ue(),[y,v]=S.useState(""),[D,H]=S.useState("all"),[t,P]=S.useState(null),[G,x]=S.useState(!1),{data:o,isLoading:Y}=z({queryKey:["journal-entries",c==null?void 0:c.id],queryFn:async()=>{if(!c)return[];const r=await W.getPrimaryMembershipByUser(c.id);if(!(r!=null&&r.companyId))return[];const i=Q($,V.JOURNAL_ENTRIES);return(await J(K(i,B("companyId","==",r.companyId)))).docs.map(j=>{const s=j.data();return{id:j.id,entryDate:Ie(s.entryDate??s.entry_date),referenceNumber:s.referenceNumber??s.reference_number??null,description:s.description??null,referenceType:s.referenceType??s.reference_type??null,referenceId:s.referenceId??s.reference_id??null,isPosted:!!(s.isPosted??s.is_posted??!1),isDeleted:!!(s.isDeleted??s.is_deleted??!1),isLocked:!!(s.isLocked??s.is_locked??!1),isReversal:!!(s.isReversal??s.is_reversal??!1),isReversed:!!(s.isReversed??s.is_reversed??!1),reversalEntryId:s.reversalEntryId??s.reversal_entry_id??null,reversalOf:s.reversalOf??s.reversal_of??null}}).filter(j=>!j.isDeleted).sort((j,s)=>String(s.entryDate).localeCompare(String(j.entryDate)))},enabled:!!c}),T=me({mutationFn:async r=>{if(!c)throw new Error("Not authenticated");const i=await W.getPrimaryMembershipByUser(c.id);if(!(i!=null&&i.companyId))throw new Error("Company context not found");const u=prompt("Reason for reversal (optional):")||void 0;return ge.reverseJournalEntry({companyId:i.companyId,journalEntryId:r.id,reason:u})},onSuccess:r=>{l.invalidateQueries({queryKey:["journal-entries",c==null?void 0:c.id]}),l.invalidateQueries({queryKey:["journal-entry-lines"]}),l.invalidateQueries({queryKey:["financial-reports"]}),l.invalidateQueries({queryKey:["dashboard-live-metrics"]}),U.success(`Journal entry reversed. Reversal ID: ${r.reversalEntryId}`),P(null)},onError:r=>{const i=r instanceof Error?r.message:"Unknown error";U.error(`Failed to reverse journal entry: ${i}`)}}),{data:h}=z({queryKey:["journal-entry-lines",t==null?void 0:t.id],queryFn:async()=>{if(!t)return[];const r=Q($,V.JOURNAL_LINES);let i=await J(K(r,B("entryId","==",t.id)));i.empty&&(i=await J(K(r,B("journalEntryId","==",t.id))));const u=i.docs.map(n=>{const a=n.data();return{id:n.id,entryId:String(a.entryId??a.journalEntryId??a.journal_entry_id??""),accountId:String(a.accountId??a.account_id??""),description:a.description??null,debitAmount:Number(a.debit??a.debitAmount??a.debit_amount??0),creditAmount:Number(a.credit??a.creditAmount??a.credit_amount??0)}}),j=Array.from(new Set(u.map(n=>n.accountId).filter(Boolean))),s=new Map;if(j.length>0){const n=Q($,V.CHART_OF_ACCOUNTS),a=Se(j,30);(await Promise.all(a.map(w=>J(K(n,B(ve(),"in",w)))))).forEach(w=>{w.docs.forEach(Z=>{const M=Z.data();s.set(Z.id,{id:Z.id,accountCode:String(M.accountCode??M.account_code??""),accountName:String(M.accountName??M.account_name??""),accountType:String(M.accountType??M.account_type??"")})})})}return u.map(n=>({...n,account:s.get(n.accountId)??null}))},enabled:!!(t!=null&&t.id)}),L=o==null?void 0:o.filter(r=>{var j,s;const i=((j=r.referenceNumber)==null?void 0:j.toLowerCase().includes(y.toLowerCase()))||((s=r.description)==null?void 0:s.toLowerCase().includes(y.toLowerCase())),u=D==="all"||D==="posted"&&r.isPosted||D==="draft"&&!r.isPosted||D==="reversed"&&r.isReversed||D==="reversal"&&r.isReversal;return!!(i||!y&&u)&&u}),_=(h==null?void 0:h.reduce((r,i)=>r+i.debitAmount,0))||0,N=(h==null?void 0:h.reduce((r,i)=>r+i.creditAmount,0))||0,f=r=>{const i=String(r.referenceType||"").toLowerCase(),u=i==="payroll"||i==="payrollpayment";return r.isPosted&&!r.isReversal&&!r.isReversed&&!u},b={total:(o==null?void 0:o.length)||0,posted:(o==null?void 0:o.filter(r=>r.isPosted).length)||0,draft:(o==null?void 0:o.filter(r=>!r.isPosted).length)||0,reversed:(o==null?void 0:o.filter(r=>r.isReversed||r.isReversal).length)||0};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Journal Entries"}),e.jsx("p",{className:"text-muted-foreground",children:"View General Ledger journal entries and postings"})]}),e.jsxs(I,{onClick:()=>x(!0),className:"gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),"Create Manual Entry"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(q,{children:e.jsxs(O,{className:"pb-2",children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),"Total Entries"]}),e.jsx(F,{className:"text-2xl",children:b.total})]})}),e.jsx(q,{children:e.jsxs(O,{className:"pb-2",children:[e.jsx(k,{children:"Posted"}),e.jsx(F,{className:"text-2xl text-green-600",children:b.posted})]})}),e.jsx(q,{children:e.jsxs(O,{className:"pb-2",children:[e.jsx(k,{children:"Draft"}),e.jsx(F,{className:"text-2xl text-amber-600",children:b.draft})]})}),e.jsx(q,{children:e.jsxs(O,{className:"pb-2",children:[e.jsx(k,{children:"Reversal Related"}),e.jsx(F,{className:"text-2xl text-orange-600",children:b.reversed})]})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(E,{placeholder:"Search by reference or description...",value:y,onChange:r=>v(r.target.value),className:"pl-9"})]}),e.jsxs(xe,{value:D,onValueChange:H,children:[e.jsxs(he,{className:"w-[150px]",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),e.jsx(je,{placeholder:"Status"})]}),e.jsxs(pe,{children:[e.jsx(A,{value:"all",children:"All Status"}),e.jsx(A,{value:"posted",children:"Posted"}),e.jsx(A,{value:"draft",children:"Draft"}),e.jsx(A,{value:"reversed",children:"Reversed"}),e.jsx(A,{value:"reversal",children:"Reversal Entries"})]})]})]}),e.jsxs(q,{children:[e.jsxs(O,{children:[e.jsx(F,{children:"Journal Entries"}),e.jsx(k,{children:"Double-entry accounting records"})]}),e.jsx(Ce,{children:Y?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(we,{className:"h-8 w-8 animate-spin"})}):L&&L.length>0?e.jsx("div",{className:"border rounded-lg overflow-x-auto",children:e.jsxs(se,{children:[e.jsx(re,{children:e.jsxs(R,{children:[e.jsx(m,{children:"Date"}),e.jsx(m,{children:"Reference"}),e.jsx(m,{children:"Source"}),e.jsx(m,{children:"Description"}),e.jsx(m,{children:"Reversal Ref"}),e.jsx(m,{children:"Status"}),e.jsx(m,{className:"text-right",children:"Actions"})]})}),e.jsx(te,{children:L.map(r=>e.jsxs(R,{children:[e.jsx(d,{children:r.entryDate?ae(new Date(r.entryDate),"dd MMM yyyy"):"-"}),e.jsx(d,{className:"font-mono",children:r.referenceNumber||"-"}),e.jsxs(d,{children:[r.referenceType||"-",r.referenceId?e.jsx("p",{className:"font-mono text-xs text-muted-foreground",children:r.referenceId}):null]}),e.jsx(d,{children:r.description||"-"}),e.jsx(d,{className:"font-mono text-xs",children:r.reversalEntryId||r.reversalOf||"-"}),e.jsx(d,{children:r.isReversal?e.jsx(g,{variant:"secondary",children:"Reversal"}):r.isReversed?e.jsx(g,{variant:"outline",className:"text-orange-600 border-orange-600",children:"Reversed"}):r.isPosted?e.jsx(g,{className:"bg-green-600",children:"Posted"}):e.jsx(g,{variant:"outline",className:"text-amber-600 border-amber-600",children:"Draft"})}),e.jsx(d,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[f(r)&&e.jsxs(I,{variant:"ghost",size:"sm",disabled:T.isPending,onClick:()=>{confirm("Reverse this posted journal entry? This action creates an equal and opposite entry.")&&T.mutate(r)},children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Reverse"]}),e.jsxs(I,{variant:"ghost",size:"sm",onClick:()=>P(r),children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"View"]})]})})]},r.id))})]})}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ee,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No journal entries found"}),e.jsx("p",{className:"text-sm",children:"Journal entries are created automatically from transactions"})]})})]}),e.jsx(ce,{open:!!t,onOpenChange:()=>P(null),children:e.jsxs(ie,{className:"max-w-3xl",children:[e.jsx(le,{children:e.jsxs(de,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5"}),"Journal Entry Details"]})}),t&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 bg-muted/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reference"}),e.jsx("p",{className:"font-mono font-medium",children:t.referenceNumber||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Date"}),e.jsx("p",{className:"font-medium",children:t.entryDate?ae(new Date(t.entryDate),"dd MMM yyyy"):"-"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Description"}),e.jsx("p",{className:"font-medium",children:t.description||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Status"}),t.isReversal?e.jsx(g,{variant:"secondary",children:"Reversal"}):t.isReversed?e.jsx(g,{variant:"outline",className:"text-orange-600 border-orange-600",children:"Reversed"}):t.isPosted?e.jsx(g,{className:"bg-green-600",children:"Posted"}):e.jsx(g,{variant:"outline",className:"text-amber-600 border-amber-600",children:"Draft"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Locked"}),t.isLocked?e.jsx(g,{variant:"secondary",children:"Yes"}):e.jsx(g,{variant:"outline",children:"No"})]}),t.referenceType&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reference Type"}),e.jsx("p",{className:"font-medium",children:t.referenceType})]}),t.referenceId&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reference ID"}),e.jsx("p",{className:"font-mono text-sm",children:t.referenceId})]}),(t.reversalEntryId||t.reversalOf)&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reversal Reference"}),e.jsx("p",{className:"font-mono text-sm",children:t.reversalEntryId||t.reversalOf})]}),!t.isReversal&&!t.isReversed&&t.isPosted&&f(t)&&e.jsx("div",{className:"col-span-2",children:e.jsxs(I,{variant:"outline",size:"sm",disabled:T.isPending,onClick:()=>{confirm("Reverse this posted journal entry? This action creates an equal and opposite entry.")&&T.mutate(t)},children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Reverse Entry"]})}),!t.isReversal&&!t.isReversed&&t.isPosted&&!f(t)&&e.jsx("div",{className:"col-span-2",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Payroll journal reversals are controlled from the payroll module to preserve sequence and audit trail."})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Entry Lines"}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(se,{children:[e.jsx(re,{children:e.jsxs(R,{children:[e.jsx(m,{children:"Account"}),e.jsx(m,{children:"Description"}),e.jsx(m,{className:"text-right",children:"Debit"}),e.jsx(m,{className:"text-right",children:"Credit"})]})}),e.jsxs(te,{children:[h==null?void 0:h.map(r=>{var i,u;return e.jsxs(R,{children:[e.jsx(d,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:((i=r.account)==null?void 0:i.accountName)||"-"}),e.jsx("p",{className:"text-sm text-muted-foreground font-mono",children:((u=r.account)==null?void 0:u.accountCode)||""})]})}),e.jsx(d,{children:r.description||"-"}),e.jsx(d,{className:"text-right",children:r.debitAmount>0?p(r.debitAmount):"-"}),e.jsx(d,{className:"text-right",children:r.creditAmount>0?p(r.creditAmount):"-"})]},r.id)}),e.jsxs(R,{className:"bg-muted/50 font-medium",children:[e.jsx(d,{colSpan:2,className:"text-right",children:"Totals"}),e.jsx(d,{className:"text-right",children:p(_)}),e.jsx(d,{className:"text-right",children:p(N)})]})]})]})}),e.jsx("div",{className:`mt-4 p-3 rounded-lg ${Math.abs(_-N)<.01?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:Math.abs(_-N)<.01?e.jsx("p",{className:"text-green-700 text-sm",children:"Entry is balanced (Debits = Credits)"}):e.jsxs("p",{className:"text-red-700 text-sm",children:["Entry is unbalanced - Difference: ",p(Math.abs(_-N))]})})]})]})]})}),e.jsx(ce,{open:G,onOpenChange:x,children:e.jsxs(ie,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(le,{children:e.jsx(de,{children:"Create Manual Journal Entry"})}),e.jsx(Re,{onClose:()=>x(!1)})]})})]})}export{Ee as default};
