import{u as oe,a0 as ue,r as S,b as z,d as W,G as H,H as L,J as k,K as A,a1 as me,j as e,k as X,I as T,q as se,s as te,t as D,v as j,w as ae,x as l,V as xe,W as he,X as je,Y as pe,Z as Q,B as I,a2 as ye,N as p,a3 as fe,O as V,P as $,y as ge,a4 as q,M as Ne,f as O,g as J,a5 as K,e as ee,h as U,U as be,a6 as ve,i as Ce,a7 as we,A as re,$ as f,a8 as ne,a9 as De,aa as ce,ab as ie,ac as de,ad as le}from"./index-DCVq7BzL.js";function Se({onClose:c}){const{user:i}=oe(),g=ue(),[y,E]=S.useState(new Date().toISOString().split("T")[0]),[F,n]=S.useState(""),[P,G]=S.useState(""),[u,o]=S.useState([{accountId:"",debit:0,credit:0,description:""},{accountId:"",debit:0,credit:0,description:""}]),{data:Y=[]}=z({queryKey:["chart-of-accounts",i==null?void 0:i.id],queryFn:async()=>{if(!i)return[];const s=await W.getPrimaryMembershipByUser(i.id);if(!(s!=null&&s.companyId))return[];const r=H($,V.CHART_OF_ACCOUNTS);return(await L(k(r,A("companyId","==",s.companyId),A("status","==","active")))).docs.map(b=>{const v=b.data();return{id:b.id,accountCode:String(v.accountCode||""),accountName:String(v.accountName||""),accountType:String(v.accountType||"")}}).sort((b,v)=>b.accountCode.localeCompare(v.accountCode))},enabled:!!i}),{data:R}=z({queryKey:["manual-journal-company-id",i==null?void 0:i.id],queryFn:async()=>{if(!i)return null;const s=await W.getPrimaryMembershipByUser(i.id);return(s==null?void 0:s.companyId)??null},enabled:!!i}),m=me({mutationFn:async s=>ge.postJournalEntry(s),onSuccess:()=>{q.success("Manual journal entry created successfully!"),g.invalidateQueries({queryKey:["journal-entries"]}),c()},onError:s=>{const r=s instanceof Error?s.message:"Failed to create journal entry";q.error(r)}}),B=()=>{o([...u,{accountId:"",debit:0,credit:0,description:""}])},M=s=>{u.length>2&&o(u.filter((r,a)=>a!==s))},N=(s,r,a)=>{const b=[...u];r==="debit"||r==="credit"?b[s][r]=Number(a)||0:b[s][r]=a,o(b)},C=u.reduce((s,r)=>s+r.debit,0),w=u.reduce((s,r)=>s+r.credit,0),t=Math.abs(C-w)<.01,d=Math.abs(C-w),x=t&&C>0&&u.every(s=>s.accountId&&(s.debit>0||s.credit>0)&&!(s.debit>0&&s.credit>0)),h=()=>{if(x){if(!R){q.error("No company context found.");return}m.mutate({companyId:R,entryDate:y,referenceNumber:F,description:P,referenceType:"ManualEntry",sourceType:"manual_journal",lines:u.filter(s=>s.accountId&&(s.debit>0||s.credit>0))})}};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"entry-date",children:"Entry Date *"}),e.jsx(T,{id:"entry-date",type:"date",value:y,onChange:s=>E(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"reference",children:"Reference Number"}),e.jsx(T,{id:"reference",placeholder:"e.g., ADJ-001",value:F,onChange:s=>n(s.target.value)})]}),e.jsxs("div",{className:"space-y-2 md:col-span-1",children:[e.jsx(X,{htmlFor:"description",children:"Description"}),e.jsx(T,{id:"description",placeholder:"Brief description of entry",value:P,onChange:s=>G(s.target.value)})]})]}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(D,{children:[e.jsx(j,{className:"w-[300px]",children:"Account"}),e.jsx(j,{children:"Line Description"}),e.jsx(j,{className:"text-right w-[120px]",children:"Debit"}),e.jsx(j,{className:"text-right w-[120px]",children:"Credit"}),e.jsx(j,{className:"w-[50px]"})]})}),e.jsxs(ae,{children:[u.map((s,r)=>e.jsxs(D,{children:[e.jsx(l,{children:e.jsxs(xe,{value:s.accountId,onValueChange:a=>N(r,"accountId",a),children:[e.jsx(he,{children:e.jsx(je,{placeholder:"Select account"})}),e.jsx(pe,{children:Y.map(a=>e.jsxs(Q,{value:a.id,children:[a.accountCode," - ",a.accountName]},a.id))})]})}),e.jsx(l,{children:e.jsx(T,{placeholder:"Line description",value:s.description,onChange:a=>N(r,"description",a.target.value)})}),e.jsx(l,{children:e.jsx(T,{type:"number",step:"0.01",min:"0",className:"text-right",value:s.debit||"",onChange:a=>N(r,"debit",a.target.value),disabled:s.credit>0})}),e.jsx(l,{children:e.jsx(T,{type:"number",step:"0.01",min:"0",className:"text-right",value:s.credit||"",onChange:a=>N(r,"credit",a.target.value),disabled:s.debit>0})}),e.jsx(l,{children:e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>M(r),disabled:u.length<=2,children:e.jsx(ye,{className:"h-4 w-4 text-destructive"})})})]},r)),e.jsxs(D,{className:"bg-muted/50",children:[e.jsx(l,{colSpan:2,className:"font-semibold",children:"Total"}),e.jsx(l,{className:"text-right font-semibold",children:p(C)}),e.jsx(l,{className:"text-right font-semibold",children:p(w)}),e.jsx(l,{})]})]})]})}),e.jsxs(I,{variant:"outline",onClick:B,className:"w-full gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),"Add Line"]}),e.jsx("div",{className:`p-4 rounded-lg border-2 ${t?"bg-green-50 border-green-500 text-green-700":"bg-red-50 border-red-500 text-red-700"}`,children:t?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-semibold",children:"Entry is balanced"}),e.jsxs("span",{children:["Debits = Credits = ",p(C)]})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-semibold",children:"Warning: Entry is not balanced"}),e.jsxs("div",{className:"text-sm",children:["Debits: ",p(C)," | Credits: ",p(w)," | Difference: ",p(d)]})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(I,{variant:"outline",onClick:c,disabled:m.isPending,children:"Cancel"}),e.jsx(I,{onClick:h,disabled:!x||m.isPending,children:m.isPending?"Posting...":"Post Entry"})]})]})}const Ie=(c,i)=>{const g=[];for(let y=0;y<c.length;y+=i)g.push(c.slice(y,y+i));return g},Re=c=>{if(!c)return"";if(typeof c=="string")return c;if(c instanceof Date)return c.toISOString();if(typeof c=="object"&&c!==null&&"toDate"in c){const i=c;if(typeof i.toDate=="function")return i.toDate().toISOString()}return""};function Ee(){const{user:c}=oe(),i=ue(),[g,y]=S.useState(""),[E,F]=S.useState("all"),[n,P]=S.useState(null),[G,u]=S.useState(!1),{data:o,isLoading:Y}=z({queryKey:["journal-entries",c==null?void 0:c.id],queryFn:async()=>{if(!c)return[];const t=await W.getPrimaryMembershipByUser(c.id);if(!(t!=null&&t.companyId))return[];const d=H($,V.JOURNAL_ENTRIES);return(await L(k(d,A("companyId","==",t.companyId)))).docs.map(h=>{const s=h.data();return{id:h.id,entryDate:Re(s.entryDate??s.entry_date),referenceNumber:s.referenceNumber??s.reference_number??null,description:s.description??null,referenceType:s.referenceType??s.reference_type??null,referenceId:s.referenceId??s.reference_id??null,isPosted:!!(s.isPosted??s.is_posted??!1),isDeleted:!!(s.isDeleted??s.is_deleted??!1),isLocked:!!(s.isLocked??s.is_locked??!1),isReversal:!!(s.isReversal??s.is_reversal??!1),isReversed:!!(s.isReversed??s.is_reversed??!1),reversalEntryId:s.reversalEntryId??s.reversal_entry_id??null}}).filter(h=>!h.isDeleted).sort((h,s)=>String(s.entryDate).localeCompare(String(h.entryDate)))},enabled:!!c}),R=me({mutationFn:async t=>{if(!c)throw new Error("Not authenticated");const d=await W.getPrimaryMembershipByUser(c.id);if(!(d!=null&&d.companyId))throw new Error("Company context not found");const x=prompt("Reason for reversal (optional):")||void 0;return ge.reverseJournalEntry({companyId:d.companyId,journalEntryId:t.id,reason:x})},onSuccess:t=>{i.invalidateQueries({queryKey:["journal-entries",c==null?void 0:c.id]}),i.invalidateQueries({queryKey:["journal-entry-lines"]}),i.invalidateQueries({queryKey:["financial-reports"]}),i.invalidateQueries({queryKey:["dashboard-live-metrics"]}),q.success(`Journal entry reversed. Reversal ID: ${t.reversalEntryId}`),P(null)},onError:t=>{const d=t instanceof Error?t.message:"Unknown error";q.error(`Failed to reverse journal entry: ${d}`)}}),{data:m}=z({queryKey:["journal-entry-lines",n==null?void 0:n.id],queryFn:async()=>{if(!n)return[];const t=H($,V.JOURNAL_LINES);let d=await L(k(t,A("entryId","==",n.id)));d.empty&&(d=await L(k(t,A("journalEntryId","==",n.id))));const x=d.docs.map(r=>{const a=r.data();return{id:r.id,entryId:String(a.entryId??a.journalEntryId??a.journal_entry_id??""),accountId:String(a.accountId??a.account_id??""),description:a.description??null,debitAmount:Number(a.debit??a.debitAmount??a.debit_amount??0),creditAmount:Number(a.credit??a.creditAmount??a.credit_amount??0)}}),h=Array.from(new Set(x.map(r=>r.accountId).filter(Boolean))),s=new Map;if(h.length>0){const r=H($,V.CHART_OF_ACCOUNTS),a=Ie(h,30);(await Promise.all(a.map(v=>L(k(r,A(Ne(),"in",v)))))).forEach(v=>{v.docs.forEach(Z=>{const _=Z.data();s.set(Z.id,{id:Z.id,accountCode:String(_.accountCode??_.account_code??""),accountName:String(_.accountName??_.account_name??""),accountType:String(_.accountType??_.account_type??"")})})})}return x.map(r=>({...r,account:s.get(r.accountId)??null}))},enabled:!!(n!=null&&n.id)}),B=o==null?void 0:o.filter(t=>{var h,s;const d=((h=t.referenceNumber)==null?void 0:h.toLowerCase().includes(g.toLowerCase()))||((s=t.description)==null?void 0:s.toLowerCase().includes(g.toLowerCase())),x=E==="all"||E==="posted"&&t.isPosted||E==="draft"&&!t.isPosted;return!!(d||!g&&x)&&x}),M=(m==null?void 0:m.reduce((t,d)=>t+d.debitAmount,0))||0,N=(m==null?void 0:m.reduce((t,d)=>t+d.creditAmount,0))||0,C=t=>t.isPosted&&!t.isReversal&&!t.isReversed,w={total:(o==null?void 0:o.length)||0,posted:(o==null?void 0:o.filter(t=>t.isPosted).length)||0,draft:(o==null?void 0:o.filter(t=>!t.isPosted).length)||0};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Journal Entries"}),e.jsx("p",{className:"text-muted-foreground",children:"View General Ledger journal entries and postings"})]}),e.jsxs(I,{onClick:()=>u(!0),className:"gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),"Create Manual Entry"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(O,{children:e.jsxs(J,{className:"pb-2",children:[e.jsxs(K,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4"}),"Total Entries"]}),e.jsx(U,{className:"text-2xl",children:w.total})]})}),e.jsx(O,{children:e.jsxs(J,{className:"pb-2",children:[e.jsx(K,{children:"Posted"}),e.jsx(U,{className:"text-2xl text-green-600",children:w.posted})]})}),e.jsx(O,{children:e.jsxs(J,{className:"pb-2",children:[e.jsx(K,{children:"Draft"}),e.jsx(U,{className:"text-2xl text-amber-600",children:w.draft})]})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(T,{placeholder:"Search by reference or description...",value:g,onChange:t=>y(t.target.value),className:"pl-9"})]}),e.jsxs(xe,{value:E,onValueChange:F,children:[e.jsxs(he,{className:"w-[150px]",children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),e.jsx(je,{placeholder:"Status"})]}),e.jsxs(pe,{children:[e.jsx(Q,{value:"all",children:"All Status"}),e.jsx(Q,{value:"posted",children:"Posted"}),e.jsx(Q,{value:"draft",children:"Draft"})]})]})]}),e.jsxs(O,{children:[e.jsxs(J,{children:[e.jsx(U,{children:"Journal Entries"}),e.jsx(K,{children:"Double-entry accounting records"})]}),e.jsx(Ce,{children:Y?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(we,{className:"h-8 w-8 animate-spin"})}):B&&B.length>0?e.jsx("div",{className:"border rounded-lg overflow-x-auto",children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(D,{children:[e.jsx(j,{children:"Date"}),e.jsx(j,{children:"Reference"}),e.jsx(j,{children:"Description"}),e.jsx(j,{children:"Status"}),e.jsx(j,{className:"text-right",children:"Actions"})]})}),e.jsx(ae,{children:B.map(t=>e.jsxs(D,{children:[e.jsx(l,{children:t.entryDate?re(new Date(t.entryDate),"dd MMM yyyy"):"-"}),e.jsx(l,{className:"font-mono",children:t.referenceNumber||"-"}),e.jsx(l,{children:t.description||"-"}),e.jsx(l,{children:t.isReversal?e.jsx(f,{variant:"secondary",children:"Reversal"}):t.isReversed?e.jsx(f,{variant:"outline",className:"text-orange-600 border-orange-600",children:"Reversed"}):t.isPosted?e.jsx(f,{className:"bg-green-600",children:"Posted"}):e.jsx(f,{variant:"outline",className:"text-amber-600 border-amber-600",children:"Draft"})}),e.jsx(l,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[C(t)&&e.jsxs(I,{variant:"ghost",size:"sm",disabled:R.isPending,onClick:()=>{confirm("Reverse this posted journal entry? This action creates an equal and opposite entry.")&&R.mutate(t)},children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Reverse"]}),e.jsxs(I,{variant:"ghost",size:"sm",onClick:()=>P(t),children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"View"]})]})})]},t.id))})]})}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ee,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No journal entries found"}),e.jsx("p",{className:"text-sm",children:"Journal entries are created automatically from transactions"})]})})]}),e.jsx(ce,{open:!!n,onOpenChange:()=>P(null),children:e.jsxs(ie,{className:"max-w-3xl",children:[e.jsx(de,{children:e.jsxs(le,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5"}),"Journal Entry Details"]})}),n&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 bg-muted/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reference"}),e.jsx("p",{className:"font-mono font-medium",children:n.referenceNumber||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Date"}),e.jsx("p",{className:"font-medium",children:n.entryDate?re(new Date(n.entryDate),"dd MMM yyyy"):"-"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Description"}),e.jsx("p",{className:"font-medium",children:n.description||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Status"}),n.isReversal?e.jsx(f,{variant:"secondary",children:"Reversal"}):n.isReversed?e.jsx(f,{variant:"outline",className:"text-orange-600 border-orange-600",children:"Reversed"}):n.isPosted?e.jsx(f,{className:"bg-green-600",children:"Posted"}):e.jsx(f,{variant:"outline",className:"text-amber-600 border-amber-600",children:"Draft"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Locked"}),n.isLocked?e.jsx(f,{variant:"secondary",children:"Yes"}):e.jsx(f,{variant:"outline",children:"No"})]}),n.referenceType&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reference Type"}),e.jsx("p",{className:"font-medium",children:n.referenceType})]}),n.referenceId&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reference ID"}),e.jsx("p",{className:"font-mono text-sm",children:n.referenceId})]}),!n.isReversal&&!n.isReversed&&n.isPosted&&e.jsx("div",{className:"col-span-2",children:e.jsxs(I,{variant:"outline",size:"sm",disabled:R.isPending,onClick:()=>{confirm("Reverse this posted journal entry? This action creates an equal and opposite entry.")&&R.mutate(n)},children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Reverse Entry"]})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-3",children:"Entry Lines"}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(se,{children:[e.jsx(te,{children:e.jsxs(D,{children:[e.jsx(j,{children:"Account"}),e.jsx(j,{children:"Description"}),e.jsx(j,{className:"text-right",children:"Debit"}),e.jsx(j,{className:"text-right",children:"Credit"})]})}),e.jsxs(ae,{children:[m==null?void 0:m.map(t=>{var d,x;return e.jsxs(D,{children:[e.jsx(l,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:((d=t.account)==null?void 0:d.accountName)||"-"}),e.jsx("p",{className:"text-sm text-muted-foreground font-mono",children:((x=t.account)==null?void 0:x.accountCode)||""})]})}),e.jsx(l,{children:t.description||"-"}),e.jsx(l,{className:"text-right",children:t.debitAmount>0?p(t.debitAmount):"-"}),e.jsx(l,{className:"text-right",children:t.creditAmount>0?p(t.creditAmount):"-"})]},t.id)}),e.jsxs(D,{className:"bg-muted/50 font-medium",children:[e.jsx(l,{colSpan:2,className:"text-right",children:"Totals"}),e.jsx(l,{className:"text-right",children:p(M)}),e.jsx(l,{className:"text-right",children:p(N)})]})]})]})}),e.jsx("div",{className:`mt-4 p-3 rounded-lg ${Math.abs(M-N)<.01?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:Math.abs(M-N)<.01?e.jsx("p",{className:"text-green-700 text-sm",children:"Entry is balanced (Debits = Credits)"}):e.jsxs("p",{className:"text-red-700 text-sm",children:["Entry is unbalanced - Difference: ",p(Math.abs(M-N))]})})]})]})]})}),e.jsx(ce,{open:G,onOpenChange:u,children:e.jsxs(ie,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(de,{children:e.jsx(le,{children:"Create Manual Journal Entry"})}),e.jsx(Se,{onClose:()=>u(!1)})]})})]})}export{Ee as default};
